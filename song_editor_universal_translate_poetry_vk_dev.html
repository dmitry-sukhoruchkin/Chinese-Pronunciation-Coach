<!-- START OF FILE song_editor_large_fonts.html -->

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Universal Music Editor (Large Fonts)</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel-bg: #252525;
            --measure-bg: #2d2d2d;
            --beat-bg: #383838;
            --highlight: #ffeb3b;
            --text-color: #eee;
            --chord-color: #ff8a80;
            --measure-border: 1px solid #555;
            --phrase-marker: #00e676;
            --accent: #2196f3;
            --trans-word-color: #4fc3f7; /* –¶–≤–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–ª–æ–≤–∞ */
            --trans-poem-color: #e0e0e0; /* –¶–≤–µ—Ç –ø–æ—ç–∑–∏–∏ */
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & JSON EDITOR --- */
        .top-section {
            background: #111;
            border-bottom: 2px solid #444;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .song-header {
            text-align: center;
            padding: 2px 0;
        }
        .song-header h1 { margin: 0; font-size: 16px; color: #ffb74d; font-family: "KaiTi", serif; }
        .song-header h2 { margin: 0; font-size: 10px; color: #888; }

        .json-toggle-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            font-size: 10px;
            padding: 2px 8px;
            cursor: pointer;
        }

        #json-panel {
            display: none;
            padding: 10px;
            background: #222;
            border-bottom: 1px solid #444;
        }
        #json-input {
            width: 98%;
            height: 100px;
            background: #111;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid #444;
            resize: vertical;
        }
        .json-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        .action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }
        .btn-load { background: var(--accent); color: white; }
        .btn-copy { background: #555; color: white; }

        /* --- CONTROLS --- */
        .controls {
            height: 50px;
            background: var(--panel-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 10px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        button.ctrl-btn {
            padding: 0 5px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 11px;
            height: 28px;
        }
        .play-btn { background: #43a047; color: white; min-width: 50px; }
        .play-btn.playing { background: #e53935; }
        .stop-btn { background: #546e7a; color: white; }
        .stop-btn.active { border: 2px solid #fff; }
        .save-btn { background: #ff9800; color: #000; margin-left: auto; }
        
        .param-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 9px; 
            color: #aaa;
            font-weight: bold; 
            min-width: 50px;
        }
        input[type=range] { width: 80px; cursor: pointer; height: 8px; margin: 1px 0; }
        input[type=range]#bpmRange { width: 130px; cursor: pointer; height: 8px; margin: 1px 0; }

        select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 0 2px;
            font-size: 10px;
            max-width: 90px;
            height: 28px;
            border-radius: 4px;
        }

        /* --- SCOREBOARD --- */
        #score-container {
            flex-grow: 1;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 4px;
            overflow-y: auto;
            position: relative;
        }

        #zoom-wrapper {
            transform-origin: top center;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; /* –ù–∞—á–∏–Ω–∞–µ–º —Å–ª–µ–≤–∞ */
            gap: 0.5%; /* –ú–∞–ª–µ–Ω—å–∫–∏–π –∑–∞–∑–æ—Ä */
        }

        .measure {
            display: flex;
            flex-direction: column;
            background: var(--measure-bg);
            border: var(--measure-border);
            border-radius: 2px;
            /* –í–û–ó–í–†–ê–©–ê–ï–ú 8 –í –†–Ø–î */
            width: 24%; 
            margin-bottom: 4px;
            position: relative;
            box-sizing: border-box;
        }

        .measure-info {
            font-size: 9px;
            color: #888;
            padding: 1px 3px;
            display: flex;
            justify-content: space-between;
            background: #222;
            border-bottom: 1px solid #444;
            height: 14px;
        }
        .sect-label { color: #ffb74d; font-weight: bold; overflow: hidden; white-space: nowrap; }

        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ --- */
        .beats-row { 
            display: flex; 
            height: 85px; /* –ë—ã–ª–æ 85px. –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤ */
        }

        /* –ü–æ–ª–µ –ø–æ—ç–∑–∏–∏ (–≤–Ω–∏–∑—É —Ç–∞–∫—Ç–∞) */
        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 6: –£–≤–µ–ª–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç –∏ –≤—ã—Å–æ—Ç–∞ --- */
        .measure-trans {
            width: 100%;
            background: #222;
            border: none;
            border-top: 1px solid #555;
            color: var(--trans-poem-color);
            font-family: 'Arial Narrow', sans-serif; 
            font-size: 13px; /* –ë—ã–ª–æ 11px */
            line-height: 1.1;
            text-align: center;
            padding: 2px;
            box-sizing: border-box;
            outline: none;
            resize: none; 
            overflow: hidden;
            min-height: 32px; /* –ë—ã–ª–æ 28px */
        }
        .measure-trans:focus { background: #000; color: #fff; min-height: 50px; position: absolute; bottom: 0; z-index: 20; border: 1px solid #aaa; }

        .beat {
            flex: 1;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã */
            position: relative;
            cursor: pointer;
            padding-bottom: 2px;
        }
        .beat:last-child { border-right: none; }
        .beat:hover { background: #444; }
        
        .beat.active {
            background-color: var(--highlight) !important;
            color: #000 !important;
            box-shadow: 0 0 10px #ffeb3b; 
            z-index: 10;
        }
        /* –í –∞–∫—Ç–∏–≤–Ω–æ–º –±–∏—Ç–µ —Ü–≤–µ—Ç–∞ –º–µ–Ω—è—é—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        .beat.active .chord-edit { color: #d50000; }
        .beat.active .lyric-edit { color: #000; font-weight: 900; }
        .beat.active .pinyin-sub { color: #333; font-weight: bold; }
        .beat.active .trans-sub { color: #0000ff; font-weight: bold; }

        .beat.editing .lyric-edit { 
            background: #444; color: #fff; z-index: 5;
        }

        .beat.phrase-start { border-bottom: 3px solid var(--phrase-marker); }

        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –£–≤–µ–ª–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç –∞–∫–∫–æ—Ä–¥–æ–≤ --- */
        .chord-edit {
            font-weight: bold; color: var(--chord-color);
            background: transparent; border: none;
            width: 100%; text-align: center;
            font-size: 16px; /* –ë—ã–ª–æ 13px */
            margin-top: 1px;
            font-family: monospace; cursor: pointer;
            height: 20px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
        }
        
        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 4: –£–≤–µ–ª–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç –∏–µ—Ä–æ–≥–ª–∏—Ñ–æ–≤ (–ì–õ–ê–í–ù–û–ï) --- */
        .lyric-edit {
            width: 100%; text-align: center;
            background: transparent; border: none;
            color: inherit; font-family: "KaiTi", "SimKai", serif;
            font-size: 24px; /* –ë—ã–ª–æ 18px */
            line-height: 1;
            overflow: visible; white-space: nowrap;
            cursor: pointer;
            margin: -2px 0;
            z-index: 2;
        }

        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –£–≤–µ–ª–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç –ø–∏–Ω—å–∏–Ω—å --- */
        .pinyin-sub {
            font-size: 10px; /* –ë—ã–ª–æ 8px */
            color: #aaa;
            width: 100%; text-align: center;
            white-space: nowrap;
            margin-top: 2px;
        }
        
        /* --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 5: –£–≤–µ–ª–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–ª–æ–≤–∞ --- */
        .trans-sub {
            font-size: 10px; /* –ë—ã–ª–æ 8px */
            color: var(--trans-word-color);
            width: 100%; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: clip;
            font-family: 'Arial Narrow', sans-serif;
            margin-bottom: 2px;
        }

        input:focus { outline: none; }

/* –í —Å–µ–∫—Ü–∏—é —Å—Ç–∏–ª–µ–π –¥–æ–±–∞–≤—å—Ç–µ */
@media (max-width: 768px) {
  .measure {
    width: 48%; /* 2 —Ç–∞–∫—Ç–∞ –≤ —Ä—è–¥ –≤–º–µ—Å—Ç–æ 4 */
  }
  
  /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  .lyric-edit {
    font-size: 20px;
  }
  
  .chord-edit {
    font-size: 14px;
  }
  
  .pinyin-sub, .trans-sub {
    font-size: 9px;
  }
  
  /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ */
  .beats-row {
    height: 65px;
  }
  
  /* –£–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
  .json-toggle-btn {
    display: none;
  }
  
  /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
  .controls {
    flex-direction: column;
    height: auto;
    padding: 5px;
  }
  
  .param-group {
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
  }
}

    </style>
    
<style>
/* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
  body {
    overflow: auto;
  }
  
  .top-section {
    padding-top: 10px;
  }
  
  .song-header h1 {
    font-size: 14px;
  }
  
  .song-header h2 {
    font-size: 9px;
  }
  
  .controls {
    height: auto;
    min-height: 50px;
    padding: 5px;
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .param-group {
    min-width: 40px;
    font-size: 8px;
  }
  
  input[type=range] {
    width: 60px;
  }
  
  input[type=range]#bpmRange {
    width: 100px;
  }
  
  select {
    max-width: 70px;
    font-size: 9px;
    height: 24px;
  }
  
  button.ctrl-btn {
    height: 24px;
    font-size: 10px;
    padding: 0 4px;
  }
  
  #score-container {
    padding: 5px;
    gap: 2px;
  }
  
  #zoom-wrapper {
    justify-content: center;
  }
  
  /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 2 —Ç–∞–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫—É */
  .measure {
    width: 48% !important;
    margin-bottom: 2px;
  }
  
  .beats-row {
    height: 75px;
  }
  
  .lyric-edit {
    font-size: 20px !important;
  }
  
  .chord-edit {
    font-size: 14px !important;
    height: 18px;
  }
  
  .pinyin-sub, .trans-sub {
    font-size: 9px !important;
  }
  
  .measure-trans {
    font-size: 11px !important;
    min-height: 28px;
  }
  
  .measure-info {
    font-size: 8px;
    height: 12px;
  }
}


/* –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º VK */
@media (max-width: 768px) {
  .json-toggle-btn {
    font-size: 8px;
    padding: 1px 6px;
    top: 2px;
    right: 5px;
  }
  
  /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö VK –∏–Ω–æ–≥–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç Web Audio API */
  #instSelect {
    display: none;
  }
}

/* –î–µ–±–∞–≥-–ø–∞–Ω–µ–ª—å */
.debug-log-entry { 
    margin-bottom: 6px; 
    padding: 4px; 
    border-left: 3px solid #444; 
}
.debug-log-entry.success { border-left-color: #4CAF50; }
.debug-log-entry.error { border-left-color: #f44336; }
.debug-log-entry.info { border-left-color: #2196F3; }
.debug-log-time { 
    color: #FF9800; 
    font-size: 9px; 
    margin-right: 5px; 
}

</style>
    
</head>
<body>

    <div class="top-section">
        <div class="song-header">
            <h1 id="song-title">Song Title</h1>
            <h2 id="song-subtitle">Artist / Description</h2>
            <button class="json-toggle-btn" onclick="toggleJsonPanel()">‚öôÔ∏è JSON / Config</button>
        </div>

        <div id="json-panel">
            <textarea id="json-input" placeholder="Paste song JSON here..."></textarea>
            <div class="json-actions">
                <button class="action-btn btn-load" onclick="loadFromInput()">üì• LOAD JSON</button>
                <button class="action-btn btn-copy" onclick="copyToClipboard()">üìã COPY</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂ PLAY</button>
        <button class="ctrl-btn stop-btn" onclick="stop()">‚èπ STOP</button>
        
        <div class="param-group">
            <span>BPM: <span id="bpmDisplay">140</span></span>
            <input type="range" id="bpmRange" min="60" max="180" value="140" oninput="updateSpeed()">
        </div>

        <div class="param-group">
            <span>VOL: <span id="volDisplay">50</span>%</span>
            <input type="range" id="volRange" min="0" max="100" value="50" oninput="updateVol()">
        </div>
        
        <select id="voiceSelect" onchange="updateVoice()">
            <option value="">Loading Voices...</option>
        </select>

        <select id="instSelect">
            <option value="sawtooth">üé∏ Guitar</option>
            <option value="triangle">üéπ Piano</option>
            <option value="sine">üîî Bell</option>
            <option value="square">üéÆ 8-bit</option>
        </select>

        <div class="param-group" style="border-left: 1px solid #444; padding-left: 5px;">
            <span>V.Spd: <span id="rateDisplay">0.6</span>x</span>
            <input type="range" id="rateRange" min="0.5" max="2.0" step="0.1" value="0.6" oninput="updateRate()">
        </div>

        <div class="param-group">
            <span>Sync: <span id="offsetDisplay">300</span>ms</span>
            <input type="range" id="offsetRange" min="0" max="1000" step="10" value="300" oninput="updateOffset()">
        </div>

        <button class="ctrl-btn stop-btn" id="ttsBtn" onclick="toggleTTS()">üó£Ô∏è –°–ª–æ–≤–∞</button>
        <button class="ctrl-btn stop-btn active" id="capoBtn" onclick="toggleCapo()">üé∏ Capo: 3</button>
        
        <button class="ctrl-btn" onclick="testTTS('—Ç–µ—Å—Ç–æ–≤—ã–π –∫–∏—Ç–∞–π—Å–∫–∏–π —Ç–µ–∫—Å—Ç ‰∏≠ÊñáÊµãËØï')" style="background: #9C27B0; color: white;">üé§ –¢–µ—Å—Ç TTS</button>
<button class="ctrl-btn" onclick="testAllTTSMethods()" style="background: #3F51B5; color: white;">üß™ –¢–µ—Å—Ç –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤</button>

        <button class="ctrl-btn save-btn" onclick="saveToJSON()" title="Save changes to JSON box">üíæ SAVE</button>
    </div>

    <div id="score-container">
        <div id="zoom-wrapper"></div>
    </div>
    
    <div id="tts-debug-panel" style="display: none; position: fixed; bottom: 10px; right: 10px; width: 320px; max-height: 300px; background: rgba(0,0,0,0.9); color: #0f0; border: 2px solid #444; border-radius: 5px; z-index: 10000; font-family: monospace; font-size: 11px; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; background: #222; padding: 5px; border-bottom: 1px solid #444;">
        <strong>üîä TTS Debug Console</strong>
        <button onclick="clearDebugLog()" style="background: #555; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Clear</button>
        <button onclick="toggleDebugPanel()" style="background: #777; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">√ó</button>
    </div>
    <div id="tts-debug-logs" style="padding: 8px; line-height: 1.4; max-height: 250px; overflow-y: auto;"></div>
</div>

<button id="tts-debug-toggle" style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; background: #ff9800; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üêû</button>

<script>
function testTTS(text) {
    logDebug('info', '–†—É—á–Ω–æ–π —Ç–µ—Å—Ç TTS', { text });
    if (isVKWebView) {
        speakViaVKBridge(text);
    } else {
        speakPhrase(text);
    }
}

async function testAllTTSMethods() {
    const testText = "ÊµãËØï‰∏≠ÊñáËØ≠Èü≥";
    logDebug('info', '–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ TTS –º–µ—Ç–æ–¥–æ–≤');
    
    // –¢–µ—Å—Ç 1: VK Bridge
    if (isVKWebView) {
        logDebug('info', '–¢–µ—Å—Ç 1: VK Bridge TTS...');
        await speakViaVKBridge(testText);
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // –¢–µ—Å—Ç 2: Web Speech API
    logDebug('info', '–¢–µ—Å—Ç 2: Web Speech API...');
    fallbackTTS(testText);
    
    // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤
    if (window.speechSynthesis) {
        const voices = window.speechSynthesis.getVoices();
        const chineseVoices = voices.filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
        logDebug('info', '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–ª–æ—Å–∞', { 
            totalVoices: voices.length,
            chineseVoices: chineseVoices.length,
            voiceNames: chineseVoices.map(v => v.name)
        });
    }
}
</script>

<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Bridge
vkBridge.send('VKWebAppInit', {})
  .then(() => console.log('VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'))
  .catch(console.error);
  
vkBridge.send('VKWebAppGetSupportedMethods')
  .then(data => {
    if (data.methods && data.methods.includes('VKWebAppTtsPlay')) {
      console.log('TTS —á–µ—Ä–µ–∑ Bridge –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    }
  });

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
let isMobileVK = false;
let isVKWebView = false;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º VK –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
const urlParams = new URLSearchParams(window.location.search);
const vkUserId = urlParams.get('vk_user_id');
const vkPlatform = urlParams.get('vk_platform');
const vkIsApp = urlParams.get('vk_is_app');

if (vkPlatform && (vkPlatform.includes('mobile') || vkIsApp)) {
  isMobileVK = true;
  isVKWebView = true;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ TTS —á–µ—Ä–µ–∑ VK Bridge
async function speakViaVKBridge(text, rate = 1.0) {
    if (!isVKWebView || !text) {
        logDebug('info', 'WebView –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, fallback –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π TTS', { text });
        fallbackTTS(text);
        return;
    }
    
    logDebug('info', '–ü–æ–ø—ã—Ç–∫–∞ VK Bridge TTS', { text, rate, platform: vkPlatform });
    
    try {
        await vkBridge.send('VKWebAppTtsPlay', {
            text: text,
            pitch: 1.0,
            rate: rate,
            volume: 1.0
        });
        logDebug('success', 'VK Bridge TTS –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ', { text });
    } catch (error) {
        logDebug('error', 'VK Bridge TTS –æ—à–∏–±–∫–∞', { 
            error: error.message, 
            errorCode: error.code,
            text: text.substring(0, 20) + '...' 
        });
        
        // –ü–æ–ø—Ä–æ–±—É–µ–º fallback —á–µ—Ä–µ–∑ —Å–æ–∑–¥–∞–Ω–∏–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥)
        logDebug('info', '–ü–æ–ø—ã—Ç–∫–∞ fallback —á–µ—Ä–µ–∑ Audio API');
        fallbackTTS(text);
    }
}

console.log('VK Platform detected:', vkPlatform, 'isVKWebView:', isVKWebView);

</script>


<script>
    // --- UPDATED SONG DATA (High Density Mode) ---
    // –§–æ—Ä–º–∞—Ç txt: "–ø–∏–Ω—å–∏–Ω—å/–∏–µ—Ä–æ–≥–ª–∏—Ñ/–ø–µ—Ä–µ–≤–æ–¥_—Å–ª–æ–≤–∞"
    const defaultSong = {
        title: "G.E.M. - Ê°ÉËä±ËØ∫ (Tao Hua Nuo)",
        subtitle: "A Life of Love and Obsession",
        bpm: 140,
        timeline: [
            { "section": "Intro", "ch": "F", "txt": ["","","",""], "trans": "(–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ)" },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },

            { "ch": "C", "txt": ["","ch≈´/Âàù/–≤–ø–µ—Ä–≤—ã–µ","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","ru√≤/Ëã•/—Å–ª–æ–≤–Ω–æ"], "trans": "–°–ª–æ–≤–Ω–æ –ø–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞..." },
            { "section": "Verse 1", "ch": "F", "txt": ["qi«én/Áº±/–ø—É—Ç—ã","","qu«én/Áªª/–ª—é–±–æ–≤—å",""], "trans": "–ù–µ—Ä–∞–∑—Ä—ã–≤–Ω–∞—è, –∑–∞–ø—É—Ç–∞–Ω–Ω–∞—è —Å–≤—è–∑—å..." },
            { "ch": "G", "txt": ["sh√¨/Ë™ì/–∫–ª—è—Ç–≤–∞","","y√°n/Ë®Ä/—Å–ª–æ–≤–∞",""], "trans": "...–Ω–∞—à–∏ –∫–ª—è—Ç–≤—ã." },
            { "ch": "Em", "txt": ["fƒìng/È£é/–≤–µ—Ç–µ—Ä","chuƒ´/Âêπ/–¥—É—Ç—å","y√∫n/‰∫ë/–æ–±–ª–∞–∫–æ","sh≈´/Ëàí/—Å–≤–æ–±–æ–¥–Ω–æ"], "trans": "–í–µ—Ç–µ—Ä —Ä–∞–∑–≥–æ–Ω—è–µ—Ç –æ–±–ª–∞–∫–∞..." },
            { "ch": "Am", "txt": ["ju«én/Âç∑/—Å–≤–µ—Ä–Ω—É—Ç—å","","su√¨/Â≤Å/–≥–æ–¥—ã","yu√®/Êúà/–º–µ—Å—è—Ü—ã"], "trans": "...–∏ –æ–Ω–∏ –ø–ª—ã–≤—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ." },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂–¥—É","","","w√®n/ÈóÆ/—Å–ø—Ä–æ—Å–∏"], "trans": "–°—Ä–µ–¥–∏ –±–µ–≥–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–ø—Ä–æ—Å–∏:" },
            { "ch": "G", "txt": ["jƒ´n/‰ªä/—Å–µ–≥–æ–¥–Ω—è","xƒ´/Â§ï/–≤–µ—á–µ—Ä","y√≤u/Âèà/—Å–Ω–æ–≤–∞",""], "trans": "–ö–∞–∫–æ–π –∂–µ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä..." },
            { "ch": "C", "txt": ["h√©/‰Ωï/–∫–∞–∫–æ–π","ni√°n/Âπ¥/–≥–æ–¥","",""], "trans": "...–∏ –∫–∞–∫–æ–π —Å–µ–π—á–∞—Å –≥–æ–¥?" },
            { "ch": "C", "txt": ["","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ","y«íu/Êúâ/–∏–º–µ—Ç—å","xƒ´/ÁäÄ/–µ–¥–∏–Ω–µ–Ω–∏–µ"], "trans": "–°–µ—Ä–¥—Ü–∞ –±—å—é—Ç—Å—è –≤ —É–Ω–∏—Å–æ–Ω." },
            { "ch": "F", "txt": ["d√†n/‰ΩÜ/–ª–∏—à—å","","yu√†n/ÊÑø/–∂–µ–ª–∞—Ç—å",""], "trans": "–õ–∏—à—å —Ö–æ—á—É —É–¥–µ—Ä–∂–∞—Ç—å..." },
            { "ch": "G", "txt": ["zh√≠/Êâß/–¥–µ—Ä–∂–∞—Ç—å","","ni√†n/Âøµ/–º—ã—Å–ª—å",""], "trans": "...—ç—Ç—É –æ–¥–Ω—É –º—ã—Å–ª—å." },
            { "ch": "Em", "txt": ["l√∫n/ËΩÆ/–∫–æ–ª–µ—Å–æ","hu√≠/Âõû/–≤–æ–∑–≤—Ä–∞—Ç","gu√≤/Ëøá/–ø—Ä–æ—à–ª–æ","jƒ´ng/Áªè/—Å–∫–≤–æ–∑—å"], "trans": "–ö–æ–ª–µ—Å–æ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π..." },
            { "ch": "Am", "txt": ["ni√°n/Âπ¥/–≥–æ–¥","","t√°n/Âºπ/—â–µ–ª—á–æ–∫","zh«ê/Êåá/–ø–∞–ª–µ—Ü"], "trans": "...–ø—Ä–æ—à–ª–æ —Å–∫–≤–æ–∑—å –≥–æ–¥–∞." },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–ø—Ä–æ–º–µ–∂—É—Ç–æ–∫","","f√°n/ÁπÅ/–ø—ã—à–Ω—ã–π","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "–í –º–≥–Ω–æ–≤–µ–Ω–∏–µ –æ–∫–∞ —Ü–≤–µ—Ç—ã..." },
            { "ch": "G", "txt": ["kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç—å","lu√≤/ËêΩ/—É–ø–∞—Å—Ç—å","du≈ç/Â§ö/–º–Ω–æ–≥–æ",""], "trans": "...—Ä–∞—Å–ø—É—Å–∫–∞–ª–∏—Å—å –∏ –æ–ø–∞–¥–∞–ª–∏..." },
            { "ch": "C", "txt": ["sh«éo/Â∞ë/–º–∞–ª–æ","bi√†n/ÈÅç/—Ä–∞–∑","",""], "trans": "...–±–µ—Å—á–∏—Å–ª–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ —Ä–∞–∑." },

            { "ch": "C", "txt": ["","zh√®/Ëøô/—ç—Ç–∞","yƒ´/‰∏Ä/–æ–¥–Ω–∞","sh√¨/‰∏ñ/–∂–∏–∑–Ω—å"], "trans": "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏..." },
            { "section": "Pre-Chorus", "ch": "F", "txt": ["qiƒÅn/Áâµ/—Ç—è–Ω—É—Ç—å","","b√†n/Áªä/–æ–∫–æ–≤—ã",""], "trans": "...–Ω–∞—à–∞ —Å–≤—è–∑—å, –∫–∞–∫ –ø—É—Ç—ã..." },
            { "ch": "G", "txt": ["ji≈´/Á∫†/—Å–ø–ª–µ—Å—Ç–∏","","ji√©/Áªì/—É–∑–µ–ª",""], "trans": "...—Å–ø–ª–µ–ª–∞—Å—å –≤ —É–∑–ª—ã." },
            { "ch": "Em", "txt": ["ch√π/Ëß¶/—Ç—Ä–æ–Ω—É—Ç—å","d√≤ng/Âä®/–¥–≤–∏–≥–∞—Ç—å","le/‰∫Ü/–ø—Ä–æ—à.–≤—Ä","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "–ò —ç—Ç–æ –∑–∞—Ç—Ä–æ–Ω—É–ª–æ..." },
            { "ch": "Am", "txt": ["xi√°n/Âº¶/—Å—Ç—Ä—É–Ω–∞","","xi√†/‰∏ã/—Å–ª–µ–¥","yƒ´/‰∏Ä/–æ–¥–∏–Ω"], "trans": "...—Å—Ç—Ä—É–Ω—ã –º–æ–µ–≥–æ —Å–µ—Ä–¥—Ü–∞." },
            { "ch": "F", "txt": ["sh√¨/‰∏ñ/–∂–∏–∑–Ω—å","","","b√π/‰∏ç/–Ω–µ"], "trans": "–í —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏..." },
            { "ch": "G", "txt": ["zhƒ´/Áü•/–∑–Ω–∞—Ç—å","kƒõ/ÂèØ/–º–æ—á—å","f«íu/Âê¶/–ª–∏",""], "trans": "...–Ω–µ –∑–Ω–∞—é, —Å–º–æ–∂–µ–º –ª–∏..." },
            { "ch": "C", "txt": ["z√†i/ÂÜç/—Å–Ω–æ–≤–∞","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","",""], "trans": "...–º—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞." },
            { "ch": "C7", "txt": ["","li√∫/Áïô/–æ—Å—Ç–∞–≤–∏—Ç—å","yƒ´/‰∏Ä/–æ–¥–∏–Ω","pi√†n/Áâá/–∫—É—Å–æ–∫"], "trans": "–û—Å—Ç–∞–≤–ª—è—é –æ–¥–∏–Ω –ª–µ–ø–µ—Å—Ç–æ–∫..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "...—Ü–≤–µ—Ç–∫–∞ –ø–µ—Ä—Å–∏–∫–∞..." },
            { "ch": "G", "txt": ["j√¨/Á∫™/–ø–∞–º—è—Ç—å","","ni√†n/Âøµ/–≤—Å–ø–æ–º–Ω–∏—Ç—å",""], "trans": "...–∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ." },
            { "ch": "Em", "txt": ["li«éo/‰∫Ü/–∑–∞–≤–µ—Ä—à–∏—Ç—å","qu√®/Âç¥/–Ω–æ","f√∫/ÊµÆ/–ø–ª—ã—Ç—å","shƒìng/Áîü/–∂–∏–∑–Ω—å"], "trans": "–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å—É–¥—å–±—É..." },
            { "ch": "Am", "txt": ["yu√°n/Áºò/—Å—É–¥—å–±–∞","","m√©i/Áúâ/–±—Ä–æ–≤–∏","m√π/ÁõÆ/–≥–ª–∞–∑–∞"], "trans": "...—ç—Ç–æ–π –±—Ä–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏." },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂","","","h√°i/Ëøò/–≤—Å—ë –µ—â–µ"], "trans": "–í —Ç–≤–æ–∏—Ö –≥–ª–∞–∑–∞—Ö..." },
            { "ch": "Dm", "txt": ["y«íu/Êúâ/–µ—Å—Ç—å","w«í/Êàë/–º–æ—è","de/ÁöÑ/–∏–∑",""], "trans": "...–≤—Å—ë –µ—â—ë –µ—Å—Ç—å..." },
            { "ch": "G", "txt": ["sƒ´/ÊÄù/–¥—É–º–∞—Ç—å","ni√†n/Âøµ/—Å–∫—É—á–∞—Ç—å","",""], "trans": "...—Ç–æ—Å–∫–∞ –æ–±–æ –º–Ω–µ." },

            { "ch": "G", "txt": ["","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","c√πn/ÂØ∏/—Ü—É–Ω—å"], "trans": "–û–¥–∏–Ω —Ü—É–Ω—å –∑–µ–º–ª–∏..." },
            { "section": "Chorus", "ch": "C", "txt": ["t«î/Âúü/–∑–µ–º–ª—è","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","ni√°n/Âπ¥/–≥–æ–¥"], "trans": "...–æ–¥–∏–Ω –≥–æ–¥ –¥–µ—Ä–µ–≤—å–µ–≤..." },
            { "ch": "G", "txt": ["m√π/Êú®/–¥–µ—Ä–µ–≤–æ","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "...–æ–¥–∏–Ω —Ü–≤–µ—Ç–æ–∫..." },
            { "ch": "Am", "txt": ["yƒ´/‰∏Ä/–æ–¥–∏–Ω","sh√π/Ê†ë/–¥—Ä–µ–≤–æ","yƒ´/‰∏Ä/–æ–¥–∏–Ω","tƒÅn/Ë¥™/–∂–∞–∂–¥–∞"], "trans": "...–æ–¥–Ω–æ –¥–µ—Ä–µ–≤–æ, –æ–¥–Ω–∞ –∂–∞–∂–¥–∞." },
            { "ch": "Em", "txt": ["t√∫/Âõæ/—Å—Ö–µ–º–∞","","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","sh√¨/ÊòØ/–µ—Å—Ç—å"], "trans": "–ß—É–≤—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ –ª—é–±–æ–≤—å..." },
            { "ch": "F", "txt": ["zh«íng/Áßç/–≤–∏–¥","","","√†i/Áà±/–ª—é–±–æ–≤—å"], "trans": "...—á—Ç–æ —Ä–∞—Å—Ü–≤–µ–ª–∞..." },
            { "ch": "C", "txt": ["piƒÅn/ÂÅè/–Ω–∞–∫–ª–æ–Ω","kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç","z√†i/Âú®/–≤",""], "trans": "...–ø–æ –æ—à–∏–±–∫–µ..." },
            { "ch": "Dm", "txt": ["m√≠/Ëø∑/–±–ª—É–∂–¥–∞—Ç—å","t√∫/ÈÄî/–ø—É—Ç—å","",""], "trans": "...–Ω–∞ –ª–æ–∂–Ω–æ–º –ø—É—Ç–∏." },
            { "ch": "G", "txt": ["","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","qi√°n/Ââç/–ø–µ—Ä–µ–¥"], "trans": "–ó–∞–±—ã—Ç—å –ø—É—Ç—å –≤–ø–µ—Ä–µ–¥..." },
            { "ch": "C", "txt": ["l√π/Ë∑Ø/–¥–æ—Ä–æ–≥–∞","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","ji√π/Êóß/—Å—Ç–∞—Ä—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å –ø—Ä–æ—à–ª–æ–µ..." },
            { "ch": "G", "txt": ["w√π/Áâ©/–≤–µ—â—å","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞–±—ã—Ç—å —á—É–≤—Å—Ç–≤–∞..." },
            { "ch": "Am", "txt": ["w√†ng/Âøò/–∑–∞–±—ã—Ç—å","n«ê/‰Ω†/—Ç—ã","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","zu√¨/ÊúÄ/—Å–∞–º—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å —Ç–µ–±—è, –∑–∞–±—ã—Ç—å –Ω–∞—á–∞–ª–æ." },
            { "ch": "Em", "txt": ["ch≈´/Âàù/–Ω–∞—á–∞–ª–æ","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "–ü—è—Ç–Ω–∞ —Ü–≤–µ—Ç–æ–≤..." },
            { "ch": "F", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "...–æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ –¥–æ—Ä–æ–≥–µ," },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–≥–¥–µ —è –ª—é–±–∏–ª–∞ —Ç–µ–±—è." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""], "trans": "" },

            { "ch": "C", "txt": ["","","",""] },
            { "section": "Instrumental", "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
 
            { "ch": "C", "txt": ["","zh√®/Ëøô/—ç—Ç–∞","yƒ´/‰∏Ä/–æ–¥–Ω–∞","sh√¨/‰∏ñ/–∂–∏–∑–Ω—å"], "trans": "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏..." },
            { "section": "Pre-Chorus", "ch": "F", "txt": ["qiƒÅn/Áâµ/—Ç—è–Ω—É—Ç—å","","b√†n/Áªä/–æ–∫–æ–≤—ã",""], "trans": "...–Ω–∞—à–∞ —Å–≤—è–∑—å, –∫–∞–∫ –ø—É—Ç—ã..." },
            { "ch": "G", "txt": ["ji≈´/Á∫†/—Å–ø–ª–µ—Å—Ç–∏","","ji√©/Áªì/—É–∑–µ–ª",""], "trans": "...—Å–ø–ª–µ–ª–∞—Å—å –≤ —É–∑–ª—ã." },
            { "ch": "Em", "txt": ["ch√π/Ëß¶/—Ç—Ä–æ–Ω—É—Ç—å","d√≤ng/Âä®/–¥–≤–∏–≥–∞—Ç—å","le/‰∫Ü/–ø—Ä–æ—à.–≤—Ä","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "–ò —ç—Ç–æ –∑–∞—Ç—Ä–æ–Ω—É–ª–æ..." },
            { "ch": "Am", "txt": ["xi√°n/Âº¶/—Å—Ç—Ä—É–Ω–∞","","xi√†/‰∏ã/—Å–ª–µ–¥","yƒ´/‰∏Ä/–æ–¥–∏–Ω"], "trans": "...—Å—Ç—Ä—É–Ω—ã –º–æ–µ–≥–æ —Å–µ—Ä–¥—Ü–∞." },
            { "ch": "F", "txt": ["sh√¨/‰∏ñ/–∂–∏–∑–Ω—å","","","b√π/‰∏ç/–Ω–µ"], "trans": "–í —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏..." },
            { "ch": "G", "txt": ["zhƒ´/Áü•/–∑–Ω–∞—Ç—å","kƒõ/ÂèØ/–º–æ—á—å","f«íu/Âê¶/–ª–∏",""], "trans": "...–Ω–µ –∑–Ω–∞—é, —Å–º–æ–∂–µ–º –ª–∏..." },
            { "ch": "C", "txt": ["z√†i/ÂÜç/—Å–Ω–æ–≤–∞","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","",""], "trans": "...–º—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞." },
            { "ch": "C7", "txt": ["","li√∫/Áïô/–æ—Å—Ç–∞–≤–∏—Ç—å","yƒ´/‰∏Ä/–æ–¥–∏–Ω","pi√†n/Áâá/–∫—É—Å–æ–∫"], "trans": "–û—Å—Ç–∞–≤–ª—è—é –æ–¥–∏–Ω –ª–µ–ø–µ—Å—Ç–æ–∫..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "...—Ü–≤–µ—Ç–∫–∞ –ø–µ—Ä—Å–∏–∫–∞..." },
            { "ch": "G", "txt": ["j√¨/Á∫™/–ø–∞–º—è—Ç—å","","ni√†n/Âøµ/–≤—Å–ø–æ–º–Ω–∏—Ç—å",""], "trans": "...–∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ." },
            { "ch": "Em", "txt": ["li«éo/‰∫Ü/–∑–∞–≤–µ—Ä—à–∏—Ç—å","qu√®/Âç¥/–Ω–æ","f√∫/ÊµÆ/–ø–ª—ã—Ç—å","shƒìng/Áîü/–∂–∏–∑–Ω—å"], "trans": "–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å—É–¥—å–±—É..." },
            { "ch": "Am", "txt": ["yu√°n/Áºò/—Å—É–¥—å–±–∞","","m√©i/Áúâ/–±—Ä–æ–≤–∏","m√π/ÁõÆ/–≥–ª–∞–∑–∞"], "trans": "...—ç—Ç–æ–π –±—Ä–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏." },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂","","","h√°i/Ëøò/–≤—Å—ë –µ—â–µ"], "trans": "–í —Ç–≤–æ–∏—Ö –≥–ª–∞–∑–∞—Ö..." },
            { "ch": "Dm", "txt": ["y«íu/Êúâ/–µ—Å—Ç—å","w«í/Êàë/–º–æ—è","de/ÁöÑ/–∏–∑",""], "trans": "...–≤—Å—ë –µ—â—ë –µ—Å—Ç—å..." },
            { "ch": "G", "txt": ["sƒ´/ÊÄù/–¥—É–º–∞—Ç—å","ni√†n/Âøµ/—Å–∫—É—á–∞—Ç—å","",""], "trans": "...—Ç–æ—Å–∫–∞ –æ–±–æ –º–Ω–µ." },

            { "ch": "G", "txt": ["","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","c√πn/ÂØ∏/—Ü—É–Ω—å"], "trans": "–û–¥–∏–Ω —Ü—É–Ω—å –∑–µ–º–ª–∏..." },
            { "section": "Chorus", "ch": "C", "txt": ["t«î/Âúü/–∑–µ–º–ª—è","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","ni√°n/Âπ¥/–≥–æ–¥"], "trans": "...–æ–¥–∏–Ω –≥–æ–¥ –¥–µ—Ä–µ–≤—å–µ–≤..." },
            { "ch": "G", "txt": ["m√π/Êú®/–¥–µ—Ä–µ–≤–æ","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "...–æ–¥–∏–Ω —Ü–≤–µ—Ç–æ–∫..." },
            { "ch": "Am", "txt": ["yƒ´/‰∏Ä/–æ–¥–∏–Ω","sh√π/Ê†ë/–¥—Ä–µ–≤–æ","yƒ´/‰∏Ä/–æ–¥–∏–Ω","tƒÅn/Ë¥™/–∂–∞–∂–¥–∞"], "trans": "...–æ–¥–Ω–æ –¥–µ—Ä–µ–≤–æ, –æ–¥–Ω–∞ –∂–∞–∂–¥–∞." },
            { "ch": "Em", "txt": ["t√∫/Âõæ/—Å—Ö–µ–º–∞","","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","sh√¨/ÊòØ/–µ—Å—Ç—å"], "trans": "–ß—É–≤—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ –ª—é–±–æ–≤—å..." },
            { "ch": "F", "txt": ["zh«íng/Áßç/–≤–∏–¥","","","√†i/Áà±/–ª—é–±–æ–≤—å"], "trans": "...—á—Ç–æ —Ä–∞—Å—Ü–≤–µ–ª–∞..." },
            { "ch": "C", "txt": ["piƒÅn/ÂÅè/–Ω–∞–∫–ª–æ–Ω","kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç","z√†i/Âú®/–≤",""], "trans": "...–ø–æ –æ—à–∏–±–∫–µ..." },
            { "ch": "Dm", "txt": ["m√≠/Ëø∑/–±–ª—É–∂–¥–∞—Ç—å","t√∫/ÈÄî/–ø—É—Ç—å","",""], "trans": "...–Ω–∞ –ª–æ–∂–Ω–æ–º –ø—É—Ç–∏." },
            { "ch": "G", "txt": ["","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","qi√°n/Ââç/–ø–µ—Ä–µ–¥"], "trans": "–ó–∞–±—ã—Ç—å –ø—É—Ç—å –≤–ø–µ—Ä–µ–¥..." },
            { "ch": "C", "txt": ["l√π/Ë∑Ø/–¥–æ—Ä–æ–≥–∞","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","ji√π/Êóß/—Å—Ç–∞—Ä—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å –ø—Ä–æ—à–ª–æ–µ..." },
            { "ch": "G", "txt": ["w√π/Áâ©/–≤–µ—â—å","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞–±—ã—Ç—å —á—É–≤—Å—Ç–≤–∞..." },
            { "ch": "Am", "txt": ["w√†ng/Âøò/–∑–∞–±—ã—Ç—å","n«ê/‰Ω†/—Ç—ã","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","zu√¨/ÊúÄ/—Å–∞–º—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å —Ç–µ–±—è, –∑–∞–±—ã—Ç—å –Ω–∞—á–∞–ª–æ." },
            { "ch": "Em", "txt": ["ch≈´/Âàù/–Ω–∞—á–∞–ª–æ","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "–ü—è—Ç–Ω–∞ —Ü–≤–µ—Ç–æ–≤..." },
            { "ch": "F", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "...–æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ –¥–æ—Ä–æ–≥–µ," },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–≥–¥–µ —è –ª—é–±–∏–ª–∞ —Ç–µ–±—è." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""], "trans": "" },

            { "ch": "C", "txt": ["","qi√°n/Ëôî/–∏—Å–∫—Ä–µ–Ω–Ω–µ","ch√©ng/ËØö/—á–µ—Å—Ç–Ω–æ","s√π/Â§ô/–¥–∞–≤–Ω–∏–π"], "trans": "–ò—Å–∫—Ä–µ–Ω–Ω–µ –º–æ–ª—é –æ —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏." },
            { "section": "Bridge", "ch": "Am", "txt": ["yu√†n/ÊÑø/–∂–µ–ª–∞—Ç—å","","l√°i/Êù•/–ø—Ä–∏–π—Ç–∏","sh√¨/‰∏ñ/–º–∏—Ä"], "trans": "–ü—É—Ç—å –≤ –º–∏—Ä –∏–Ω–æ–π..." },
            { "ch": "Em", "txt": ["l√π/Ë∑Ø/–ø—É—Ç—å","","yƒ´/‰∏Ä/–æ–¥–Ω–∞","ni√†n/Âøµ/–º—ã—Å–ª—å"], "trans": "...–æ–¥–Ω–∞ –º—ã—Å–ª—å..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫","yƒ´n/Âõ†/–ø—Ä–∏—á–∏–Ω–∞","gu«í/Êûú/—Å–ª–µ–¥—Å—Ç–≤–∏–µ"], "trans": "...–æ —Ü–≤–µ—Ç–∞—Ö –ø–µ—Ä—Å–∏–∫–∞ –∏ –∫–∞—Ä–º–µ." },
            { "ch": "G", "txt": ["d√π/Ê∏°/–ø–µ—Ä–µ–ø—Ä–∞–≤–∞","","n√†/ÈÇ£/—Ç–æ—Ç","yƒ´/‰∏Ä/–æ–¥–∏–Ω"], "trans": "–ü–µ—Ä–µ–ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑..." },
            { "ch": "C", "txt": ["ni√†n/Âøµ/–º—ã—Å–ª—å","","j«ê/Âá†/—Å–∫–æ–ª—å–∫–æ","quƒì/Èòô/–ø–µ—Å–µ–Ω"], "trans": "...—Ç–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ." },
            { "ch": "G", "txt": ["sh√≠/Êó∂/–≤—Ä–µ–º—è","guƒÅng/ÂÖâ/—Å–≤–µ—Ç","z√†i/Âú®/–≤",""], "trans": "–°–∫–æ–ª—å–∫–æ —Ä–∞–∑..." },
            { "ch": "C", "txt": ["ch√≥ng/Èáç/—Å–Ω–æ–≤–∞","f√π/Â§ç/–ø–æ–≤—Ç–æ—Ä","",""], "trans": "...–≤—Ä–µ–º—è –ø–æ–≤—Ç–æ—Ä—è–ª–æ—Å—å?" },

            { "ch": "E", "txt": ["","","tƒ´ng/Âê¨/—Å–ª—É—à–∞—Ç—å","y«î/Èõ®/–¥–æ–∂–¥—å"], "trans": "–°–ª—É—à–∞—è –¥–æ–∂–¥—å..." },
            { "section": "Ending", "ch": "Am", "txt": ["sh≈´/‰π¶/–ø–∏—Å–∞—Ç—å","","w√†ng/Êúõ/—Å–º–æ—Ç—Ä–µ—Ç—å","tiƒÅn/Â§©/–Ω–µ–±–æ"], "trans": "...–≥–ª—è–¥—è –Ω–∞ –Ω–µ–±–æ..." },
            { "ch": "Em", "txt": ["h√∫/Êπñ/–æ–∑–µ—Ä–æ","","r√©n/‰∫∫/—á–µ–ª–æ–≤–µ–∫","jiƒÅn/Èó¥/–º–µ–∂"], "trans": "...–∏ –Ω–∞ –æ–∑–µ—Ä–æ." },
            { "ch": "F", "txt": ["li√°o/ÂØ•/–ø—É—Å—Ç–æ","li√°o/ÂØ•/—Ç–∏—Ö–æ","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","n√°n/Èöæ/—Ç—Ä—É–¥–Ω–æ"], "trans": "–í –º–∏—Ä–µ –ª—é–¥–µ–π –æ–¥–∏–Ω–æ–∫–æ..." },
            { "ch": "G", "txt": ["s√π/ËØâ/—Å–∫–∞–∑–∞—Ç—å","","hu√≠/Âõû/–≤–æ–∑–≤—Ä–∞—Ç","y√¨/ÂøÜ/–ø–∞–º—è—Ç—å"], "trans": "...—á—É–≤—Å—Ç–≤–∞ —Ç—Ä—É–¥–Ω–æ –≤—ã—Ä–∞–∑–∏—Ç—å." },
            { "ch": "C", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—è—Ç–Ω–∞–º–∏..." },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–Ω–∞ –¥–æ—Ä–æ–≥–µ –ª—é–±–≤–∏." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""], "trans": "" },

            { "ch": "C", "txt": ["","","",""], "trans": "" },
            { "section": "Outro", "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
        ]
    };

    // --- GLOBAL STATE ---
    let currentSong = JSON.parse(JSON.stringify(defaultSong));
    let audioCtx = null;
    let masterGain = null;
    
    // TIMING VARIABLES
    let isPlaying = false;
    let lookahead = 25.0; 
    
    // === –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ===
    // –ë—ã–ª–æ 0.1. –°—Ç–∞–≤–∏–º 1.5, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è 
    // –±–æ–ª–µ–µ —á–µ–º –∑–∞ 1000–º—Å (–º–∞–∫—Å–∏–º—É–º –≤–∞—à–µ–≥–æ –ø–æ–ª–∑—É–Ω–∫–∞ Sync)
    let scheduleAheadTime = 1.5; 
    // ==============================

    let nextNoteTime = 0.0;
    let timerID; 
    let notesInQueue = []; 

    // State
    let currentBar = 0;
    let currentBeat = 0;
    
    // Preferences
    let bpm = 140; // –ß—É—Ç—å –ø–æ–ø—Ä–∞–≤–∏–ª –¥–µ—Ñ–æ–ª—Ç –ø–æ–¥ –ø–µ—Å–Ω—é
    let ttsRate = 0.6; 
    let ttsOffset = 600; // –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let isCapo = true;
    let isTTS = true;
    
    let selectedVoice = null;
    let availableVoices = [];
    let phraseCache = {}; 

    const noteMap = {'C':261.63,'C#':277.18,'Db':277.18,'D':293.66,'D#':311.13,'Eb':311.13,'E':329.63,'F':349.23,'F#':369.99,'Gb':369.99,'G':392.00,'G#':415.30,'Ab':415.30,'A':440.00,'A#':466.16,'Bb':466.16,'B':493.88};
    const semitones = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

// ================== TTS DEBUGGER ==================
let ttsDebugEnabled = true;
let debugLogs = [];

function logDebug(type, message, details = null) {
    if (!ttsDebugEnabled) return;
    
    const time = new Date().toLocaleTimeString();
    const logEntry = { time, type, message, details };
    debugLogs.push(logEntry);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    const logElement = document.createElement('div');
    logElement.className = `debug-log-entry ${type}`;
    logElement.innerHTML = `
        <span class="debug-log-time">[${time}]</span>
        <strong>${message}</strong>
        ${details ? `<div style="color: #aaa; font-size: 10px; margin-top: 2px;">${JSON.stringify(details)}</div>` : ''}
    `;
    
    const logsContainer = document.getElementById('tts-debug-logs');
    if (logsContainer) {
        logsContainer.appendChild(logElement);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞–º–∏
    try {
        const savedLogs = JSON.parse(localStorage.getItem('ttsDebugLogs') || '[]');
        savedLogs.push(logEntry);
        if (savedLogs.length > 50) savedLogs.shift();
        localStorage.setItem('ttsDebugLogs', JSON.stringify(savedLogs));
    } catch(e) {}
}

function toggleDebugPanel() {
    const panel = document.getElementById('tts-debug-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function clearDebugLog() {
    debugLogs = [];
    const logsContainer = document.getElementById('tts-debug-logs');
    if (logsContainer) logsContainer.innerHTML = '';
    localStorage.removeItem('ttsDebugLogs');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –¥–µ–±–∞–≥–∞
document.getElementById('tts-debug-toggle')?.addEventListener('click', toggleDebugPanel);

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
window.addEventListener('load', function() {
    try {
        const savedLogs = JSON.parse(localStorage.getItem('ttsDebugLogs') || '[]');
        savedLogs.forEach(log => {
            const logElement = document.createElement('div');
            logElement.className = `debug-log-entry ${log.type}`;
            logElement.innerHTML = `
                <span class="debug-log-time">[${log.time}]</span>
                <strong>${log.message}</strong>
                ${log.details ? `<div style="color: #aaa; font-size: 10px;">${JSON.stringify(log.details)}</div>` : ''}
            `;
            document.getElementById('tts-debug-logs')?.appendChild(logElement);
        });
    } catch(e) {}
});
    // --- INIT ---
function init() {
  document.getElementById('json-input').value = JSON.stringify(currentSong, null, 4);
  applySongData();
  
  // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö VK —Å–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  if (isMobileVK) {
    document.getElementById('instSelect').style.display = 'none';
    document.getElementById('voiceSelect').disabled = true;
    document.getElementById('voiceSelect').innerHTML = '<option value="">TTS: VK Bridge</option>';
  } else {
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();
  }
  
  requestAnimationFrame(draw);
}

    // --- JSON EDITOR ---
    function toggleJsonPanel() {
        const p = document.getElementById('json-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    function loadFromInput() {
        try {
            const raw = document.getElementById('json-input').value;
            const parsed = JSON.parse(raw);
            if(!parsed.timeline) throw new Error("Missing 'timeline'");
            stop();
            currentSong = parsed;
            applySongData();
            document.getElementById('json-panel').style.display = 'none';
        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    function applySongData() {
        document.getElementById('song-title').innerText = currentSong.title || "Untitled";
        document.getElementById('song-subtitle').innerText = currentSong.subtitle || "";
        bpm = currentSong.bpm || 120;
        document.getElementById('bpmRange').value = bpm;
        document.getElementById('bpmDisplay').innerText = bpm;
        resetPlayhead();
        generatePhrases();
        renderScore();
    }

    function saveToJSON() {
        currentSong.bpm = bpm;
        document.getElementById('json-input').value = JSON.stringify(currentSong, null, 4);
        document.getElementById('json-panel').style.display = 'block';
    }

    function copyToClipboard() {
        document.getElementById('json-input').select();
        document.execCommand('copy');
    }

    // --- VOICE ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = "";
        
        availableVoices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.innerText = v.name.substring(0, 20) + (v.name.length>20?'...':'');
            select.appendChild(opt);
        });

        let target = availableVoices.find(v => v.name === "Google ÂúãË™ûÔºàËá∫ÁÅ£Ôºâ") || 
                     availableVoices.find(v => v.lang.includes('zh'));
        
        if (target) {
            select.value = target.name;
            selectedVoice = target;
        } else if (availableVoices.length) {
            selectedVoice = availableVoices[0];
            select.value = availableVoices[0].name;
        }
    }
    
    function updateVoice() {
        selectedVoice = availableVoices.find(v => v.name === document.getElementById('voiceSelect').value);
    }

    // --- LOGIC ---
    function generatePhrases() {
        phraseCache = {}; 
        let currentPhrase = "";
        let startKey = null;

        currentSong.timeline.forEach((m, mIdx) => {
            m.txt.forEach((txt, bIdx) => {
                let parts = txt.split('/');
                let hz = parts.length > 1 ? parts[1] : txt;
                let key = `${mIdx}-${bIdx}`;
                
                if (hz) {
                    if (!currentPhrase) startKey = key;
                    currentPhrase += hz;
                } else {
                    if (currentPhrase && startKey) {
                        phraseCache[startKey] = currentPhrase;
                        currentPhrase = "";
                        startKey = null;
                    }
                }
            });
        });
        if (currentPhrase && startKey) phraseCache[startKey] = currentPhrase;
    }

    function renderScore() {
        const wrapper = document.getElementById('zoom-wrapper');
        wrapper.innerHTML = '';
        
        currentSong.timeline.forEach((m, mIdx) => {
            const mDiv = document.createElement('div');
            mDiv.className = 'measure';
            mDiv.id = `m-${mIdx}`;
            
            const info = document.createElement('div');
            info.className = 'measure-info';
            info.innerHTML = `<span>${mIdx+1}</span>` + (m.section ? `<span class="sect-label">${m.section}</span>` : ``);
            mDiv.appendChild(info);

            const row = document.createElement('div');
            row.className = 'beats-row';

            for (let b=0; b<4; b++) {
                const bDiv = document.createElement('div');
                bDiv.className = 'beat';
                bDiv.id = `b-${mIdx}-${b}`;
                if(phraseCache[`${mIdx}-${b}`]) bDiv.classList.add('phrase-start');

                bDiv.onclick = (e) => {
                    if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') seekTo(mIdx, b);
                };

                // Chord
                if (b === 0) {
                    const cIn = document.createElement('input');
                    cIn.className = 'chord-edit';
                    cIn.value = m.ch || '';
                    cIn.onchange = (e) => { m.ch = e.target.value; };
                    bDiv.appendChild(cIn);
                } else {
                    bDiv.innerHTML += '<div style="height:18px"></div>';
                }

                // Lyric Data Parsing
                let rawText = m.txt[b] || "";
                let parts = rawText.split('/');
                let py = parts.length > 0 ? parts[0] : "";
                let hz = parts.length > 1 ? parts[1] : "";
                let transWord = parts.length > 2 ? parts[2] : "";

                // Pinyin
                const pDiv = document.createElement('div');
                pDiv.className = 'pinyin-sub';
                pDiv.innerText = py;
                bDiv.appendChild(pDiv);

                // Hanzi Input
                const lIn = document.createElement('input');
                lIn.className = 'lyric-edit';
                lIn.value = hz;
                lIn.onfocus = (e) => {
                    bDiv.classList.add('editing');
                    e.target.value = m.txt[b] || ""; // Show full source on edit
                };
                lIn.onblur = (e) => {
                    bDiv.classList.remove('editing');
                    m.txt[b] = e.target.value;
                    generatePhrases();
                    renderScore(); 
                };
                lIn.onkeydown = (e) => { if(e.key === 'Enter') lIn.blur(); };
                bDiv.appendChild(lIn);

                // Word Translation (Restored)
                const tDiv = document.createElement('div');
                tDiv.className = 'trans-sub';
                tDiv.innerText = transWord;
                bDiv.appendChild(tDiv);

                row.appendChild(bDiv);
            }
            mDiv.appendChild(row);

            // --- TEXTAREA FOR POETRY (Inside Measure) ---
            const transInput = document.createElement('textarea');
            transInput.className = 'measure-trans';
            transInput.value = m.trans || "";
            transInput.placeholder = "...";
            transInput.onchange = (e) => {
                m.trans = e.target.value;
            };
            // Auto-resize logic on render
            if(m.trans && m.trans.length > 15) {
                 // rough height estimate
            }

            mDiv.appendChild(transInput);

            wrapper.appendChild(mDiv);
        });
    }

    // --- AUDIO & SYNC ---

function initAudio() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      updateVol();
      masterGain.connect(audioCtx.destination);
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  } catch (e) {
    console.error("Audio initialization failed", e);
    // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ VK –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    if (document.body.classList.contains('mobile-vk')) {
      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ VK Bridge –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞
    }
  }
}

    function togglePlay() { 
        initAudio(); 
        if(isPlaying) stop(); else play(); 
    }

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é play –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –º–æ–±–∏–ª—å–Ω–æ–º WebView
function play() {
  if (isPlaying) return;
  
  // –í–∞–∂–Ω–æ: –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∂–µ—Å—Ç–∞
  

  try {
    initAudio();
  // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
  if (audioCtx && audioCtx.state === 'suspended') {
    audioCtx.resume().then(() => {
      startPlayback();
    }).catch(console.error);
  } else {
    startPlayback();
  }
  } catch (error) {
    console.error('Playback error:', error);
    // –°–±—Ä–æ—Å—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    isPlaying = false;
    document.getElementById('playBtn').innerText = "‚ñ∂ PLAY";
    document.getElementById('playBtn').classList.remove('playing');
  }

}

function startPlayback() {
  if (isPlaying) return;
  isPlaying = true;
  nextNoteTime = audioCtx.currentTime + 0.1;
  document.getElementById('playBtn').innerText = "‚è∏ PAUSE";
  document.getElementById('playBtn').classList.add('playing');
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –≤–º–µ—Å—Ç–æ setInterval –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
  lastSchedulerTime = performance.now();
  schedulerFrame();
}

let lastSchedulerTime = 0;
function schedulerFrame() {
  if (!isPlaying) return;
  
  scheduler();
  
  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: —Ä–µ–≥—É–ª–∏—Ä—É–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const now = performance.now();
  const elapsed = now - lastSchedulerTime;
  
  if (elapsed >= lookahead) {
    lastSchedulerTime = now;
    scheduler();
  }
  
  if (isPlaying) {
    requestAnimationFrame(schedulerFrame);
  }
}

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º requestAnimationFrame –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
function stop() {
  isPlaying = false;
  window.speechSynthesis.cancel();
  
  // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è TTS
  for (let i = scheduledTtsTimeouts.length - 1; i >= 0; i--) {
    clearTimeout(scheduledTtsTimeouts[i]);
  }
  scheduledTtsTimeouts = [];
  
  document.getElementById('playBtn').innerText = "‚ñ∂ PLAY";
  document.getElementById('playBtn').classList.remove('playing');
  document.querySelectorAll('.beat.active').forEach(e => e.classList.remove('active'));
  notesInQueue = [];
}

    function resetPlayhead() {
        currentBar = 0;
        currentBeat = 0;
        notesInQueue = [];
    }

    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
            scheduleNote(currentBar, currentBeat, nextNoteTime);
            nextNote();
        }
    }

// –ú–∞—Å—Å–∏–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö TTS —Ç–∞–π–º–∞—É—Ç–æ–≤
let scheduledTtsTimeouts = [];

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è scheduleNote –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
function scheduleNote(bar, beat, time) {
  notesInQueue.push({ noteTime: time, bar: bar, beat: beat });
  if (bar >= currentSong.timeline.length) return;

  let m = currentSong.timeline[bar];
  
  // –ü–ª–∞–Ω–∏—Ä—É–µ–º –∑–≤—É–∫
  if (m && m.ch) playSound(m.ch, beat, time);

  // –ü–ª–∞–Ω–∏—Ä—É–µ–º —Ä–µ—á—å (TTS)
  if (isTTS) {
    let key = `${bar}-${beat}`;
    if(phraseCache[key]) {
      let now = audioCtx.currentTime;
      let delaySeconds = time - now;
      let timeoutMs = (delaySeconds * 1000) - ttsOffset;
      
      if (timeoutMs < 0) timeoutMs = 0;
      
      const timeoutId = setTimeout(() => { 
        if (isPlaying) speakPhrase(phraseCache[key]); 
        // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        const index = scheduledTtsTimeouts.indexOf(timeoutId);
        if (index > -1) scheduledTtsTimeouts.splice(index, 1);
      }, timeoutMs);
      
      scheduledTtsTimeouts.push(timeoutId);
    }
  }
}

    function nextNote() {
        const secondsPerBeat = 60.0 / bpm;
        nextNoteTime += secondsPerBeat;
        currentBeat++;
        if (currentBeat === 4) {
            currentBeat = 0;
            currentBar++;
            if (currentBar >= currentSong.timeline.length) {
                setTimeout(() => stop(), 2000); 
                isPlaying = false; 
                clearInterval(timerID);
            }
        }
    }

    function draw() {
        let currentTime = audioCtx ? audioCtx.currentTime : 0;
        while (notesInQueue.length && notesInQueue[0].noteTime < currentTime) {
            let currentNote = notesInQueue[0];
            notesInQueue.splice(0,1); 
            updateHighlight(currentNote.bar, currentNote.beat);
        }
        requestAnimationFrame(draw);
    }

    function getFreqs(chord, isWeak) {
        if (!chord) return [];
        let root = chord.match(/^[A-G][#b]?/)[0];
        let type = chord.slice(root.length);
        let idx = semitones.findIndex(n => n === root);
        if(idx === -1) return [];
        let shift = isCapo ? 3 : 0;
        let realIdx = (idx + shift) % 12;
        let base = noteMap[semitones[realIdx]];
        let f1 = base / 2;
        let f2 = type.includes('m') ? f1*Math.pow(2, 3/12) : f1*Math.pow(2, 4/12);
        let f3 = f1*Math.pow(2, 7/12);
        let f4 = f1*2;
        return isWeak ? [f2, f3, f4] : [f1, f2, f3, f4];
    }

    function playSound(chord, beat, time) {
        if (!audioCtx || !masterGain || !chord) return;
        let isWeak = beat > 0;
        let freqs = getFreqs(chord, isWeak);
        let dur = isWeak ? 0.08 : 0.12; 
        let type = document.getElementById('instSelect').value || 'sawtooth';

        freqs.forEach((f, i) => {
            let o = audioCtx.createOscillator();
            let g = audioCtx.createGain();
            o.type = type; 
            o.frequency.value = f;
            
            let start = time + i*(isWeak?0.004:0.008); 
            g.gain.setValueAtTime(0, start);
            g.gain.linearRampToValueAtTime(isWeak?0.2:0.3, start+0.01);
            g.gain.exponentialRampToValueAtTime(0.001, start+dur+0.1);
            
            o.connect(g); g.connect(masterGain);
            o.start(start); o.stop(start+dur+0.2);
        });
    }

    function seekTo(m, b) {
        let wasPlaying = isPlaying;
        if(wasPlaying) stop();
        
        currentBar = m;
        currentBeat = b;
        updateHighlight(m, b);

        if(wasPlaying) play();
        else {
            let txt = currentSong.timeline[m].txt[b];
            let parts = txt.split('/');
            let hz = parts.length > 1 ? parts[1] : txt;
            if(hz) speakPhrase(hz);
        }
    }

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è speakPhrase
function speakPhrase(text) {
  console.log('TTS –≤—ã–∑–æ–≤:', text);
  
  if (!text) return;

    if (isVKWebView) {
        vkBridge.send('VKWebAppTtsPlay', {
            text: text,
            pitch: 1.0,
            rate: ttsRate,
            volume: 1.0
        }).catch(error => {
            console.error('–û—à–∏–±–∫–∞ VK TTS:', error);
            // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å fallback, –µ—Å–ª–∏ –µ—Å—Ç—å
        });
        return;
    }

  // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ VK –∏—Å–ø–æ–ª—å–∑—É–µ–º VK Bridge
  if (isMobileVK) {
    speakViaVKBridge(text, ttsRate);
    return;
  }
  
  // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-CN';
    u.rate = ttsRate;
    if(selectedVoice) u.voice = selectedVoice;
    
    u.onerror = function(event) {
      console.error('TTS Error:', event);
    };
    
    window.speechSynthesis.speak(u);
  } else {
    console.log('TTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
  }
}

function fallbackTTS(text) {
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-CN';
    u.rate = ttsRate;
    if(selectedVoice) u.voice = selectedVoice;
    u.onerror = function(event) {
      console.error('TTS Error:', event);
    };
    window.speechSynthesis.speak(u);
  }
}



    function updateHighlight(m, b) {
        document.querySelectorAll('.beat.active').forEach(e => e.classList.remove('active'));
        const el = document.getElementById(`b-${m}-${b}`);
        if(el) {
            el.classList.add('active');
            el.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
        }
    }

    function updateVol() { 
        let v = document.getElementById('volRange').value;
        document.getElementById('volDisplay').innerText = v;
        if(masterGain) masterGain.gain.value = v/100; 
    }
    function updateSpeed() { 
        bpm = parseInt(document.getElementById('bpmRange').value); 
        document.getElementById('bpmDisplay').innerText = bpm; 
    }
    function updateRate() {
        ttsRate = parseFloat(document.getElementById('rateRange').value);
        document.getElementById('rateDisplay').innerText = ttsRate.toFixed(1);
    }
    function updateOffset() {
        ttsOffset = parseInt(document.getElementById('offsetRange').value);
        document.getElementById('offsetDisplay').innerText = ttsOffset;
    }
    function toggleTTS() { 
        isTTS = !isTTS; 
        document.getElementById('ttsBtn').innerText = isTTS?"üó£Ô∏è –°–ª–æ–≤–∞: –í–ö–õ":"üó£Ô∏è –°–ª–æ–≤–∞: –í–´–ö–õ"; 
    }
    function toggleCapo() { 
        isCapo = !isCapo; 
        document.getElementById('capoBtn').classList.toggle('active', isCapo); 
    }

    init();

</script>
</body>
</html>
