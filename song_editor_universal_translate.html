<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Music Editor (Precision Timing)</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel-bg: #252525;
            --measure-bg: #2d2d2d;
            --beat-bg: #383838;
            --highlight: #ffeb3b;
            --text-color: #eee;
            --chord-color: #ff8a80;
            --measure-border: 1px solid #555;
            --phrase-marker: #00e676;
            --accent: #2196f3;
            --trans-color: #4fc3f7;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & JSON EDITOR --- */
        .top-section {
            background: #111;
            border-bottom: 2px solid #444;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .song-header {
            text-align: center;
            padding: 5px 0;
            position: relative;
        }
        .song-header h1 { margin: 0; font-size: 18px; color: #ffb74d; font-family: "KaiTi", serif; }
        .song-header h2 { margin: 0; font-size: 11px; color: #888; }

        .json-toggle-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            font-size: 10px;
            padding: 2px 8px;
            cursor: pointer;
        }

        #json-panel {
            display: none;
            padding: 10px;
            background: #222;
            border-bottom: 1px solid #444;
        }
        #json-input {
            width: 98%;
            height: 100px;
            background: #111;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid #444;
            resize: vertical;
        }
        .json-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        .action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }
        .btn-load { background: var(--accent); color: white; }
        .btn-copy { background: #555; color: white; }

        /* --- CONTROLS --- */
        .controls {
            height: 60px;
            background: var(--panel-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 10px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        button.ctrl-btn {
            padding: 0 10px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 11px;
            height: 30px;
        }
        .play-btn { background: #43a047; color: white; min-width: 50px; }
        .play-btn.playing { background: #e53935; }
        .stop-btn { background: #546e7a; color: white; }
        .stop-btn.active { border: 2px solid #fff; }
        .save-btn { background: #ff9800; color: #000; margin-left: auto; }
        
        .param-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 9px; 
            color: #aaa;
            font-weight: bold; 
            min-width: 50px;
        }
        input[type=range] { width: 100px; cursor: pointer; height: 10px; margin: 2px 0; }

        select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 0 2px;
            font-size: 10px;
            max-width: 90px;
            height: 30px;
            border-radius: 4px;
        }

        /* --- SCOREBOARD --- */
        #score-container {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 4px;
            overflow-y: auto;
            position: relative;
            padding-bottom: 180px; 
        }

        #zoom-wrapper {
            transform-origin: top center;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .measure {
            display: flex;
            flex-direction: column;
            background: var(--measure-bg);
            border: var(--measure-border);
            border-radius: 2px;
            width: 12.2%; 
            margin-bottom: 4px;
            position: relative;
        }

        .measure-info {
            font-size: 10px;
            color: #888;
            padding: 1px 4px;
            display: flex;
            justify-content: space-between;
            background: #222;
        }
        .sect-label { color: #ffb74d; font-weight: bold; }

        .beats-row { display: flex; height: 75px; }

        .beat {
            flex: 1;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: pointer;
            transition: background 0.02s; /* Super fast transition for strict timing */
        }
        .beat:last-child { border-right: none; }
        .beat:hover { background: #444; }
        
        .beat.active {
            background-color: var(--highlight) !important;
            color: #000 !important;
            box-shadow: 0 0 15px #ffeb3b; 
            z-index: 10;
        }
        .beat.active .chord-edit { color: #d50000; }
        .beat.active .lyric-edit { color: #000; font-weight: bold; }
        
        .beat.editing .pinyin-sub, .beat.editing .trans-sub { opacity: 0; }
        .beat.editing .lyric-edit { 
            font-size: 11px; font-family: monospace; 
            background: #444; color: #fff;
            margin-top: 20px;
        }

        .beat.phrase-start { border-bottom: 4px solid var(--phrase-marker); }

        .chord-edit {
            font-weight: bold; color: var(--chord-color);
            background: transparent; border: none;
            width: 100%; text-align: center;
            font-size: 14px; margin-top: 2px;
            font-family: monospace; cursor: pointer;
            z-index: 2;
        }
        
        .lyric-edit {
            width: 100%; text-align: center;
            background: transparent; border: none;
            color: inherit; font-family: "KaiTi", "SimKai", serif;
            font-size: 20px; line-height: 1;
            overflow: hidden; white-space: nowrap;
            cursor: pointer;
            position: absolute;
            top: 32px;
            z-index: 2;
        }

        .pinyin-sub {
            font-size: 9px; color: #aaa;
            pointer-events: none; position: absolute;
            top: 18px; width: 100%; text-align: center;
            transition: opacity 0.1s;
        }
        
        .trans-sub {
            font-size: 9px; color: var(--trans-color);
            pointer-events: none; position: absolute;
            bottom: 4px; width: 100%; text-align: center;
            transition: opacity 0.1s;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            padding: 0 1px;
        }

        .beat.active .pinyin-sub { color: #333; }
        .beat.active .trans-sub { color: #000; font-weight: bold; }

        input:focus { outline: none; }

        /* --- TELEPROMPTER --- */
        #teleprompter-container {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 160px;
            background: rgba(0, 0, 0, 0.95);
            border-top: 2px solid #ffb74d;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            overflow: hidden;
        }

        #lyrics-list {
            list-style: none;
            padding: 0; margin: 0;
            width: 100%;
            text-align: center;
            padding-top: 60px; 
            padding-bottom: 60px;
            transition: transform 0.3s ease-out;
        }

        .lyric-line {
            font-family: "Georgia", serif;
            font-size: 16px;
            color: #666;
            padding: 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 30px;
            display: flex; align-items: center; justify-content: center;
        }

        .lyric-line.active {
            color: #fff;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .lyric-line:hover { color: #aaa; }

    </style>
</head>
<body>

    <div class="top-section">
        <div class="song-header">
            <h1 id="song-title">Song Title</h1>
            <h2 id="song-subtitle">Artist / Description</h2>
            <button class="json-toggle-btn" onclick="toggleJsonPanel()">‚öôÔ∏è JSON / Config</button>
        </div>

        <div id="json-panel">
            <textarea id="json-input" placeholder="Paste song JSON here..."></textarea>
            <div class="json-actions">
                <button class="action-btn btn-load" onclick="loadFromInput()">üì• LOAD JSON</button>
                <button class="action-btn btn-copy" onclick="copyToClipboard()">üìã COPY</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="ctrl-btn play-btn" id="playBtn" onclick="togglePlay()">‚ñ∂ PLAY</button>
        <button class="ctrl-btn stop-btn" onclick="stop()">‚èπ STOP</button>
        
        <div class="param-group">
            <span>BPM: <span id="bpmDisplay">140</span></span>
            <input type="range" id="bpmRange" min="60" max="180" value="140" oninput="updateSpeed()">
        </div>

        <div class="param-group">
            <span>VOL: <span id="volDisplay">50</span>%</span>
            <input type="range" id="volRange" min="0" max="100" value="50" oninput="updateVol()">
        </div>
        
        <select id="voiceSelect" onchange="updateVoice()">
            <option value="">Loading Voices...</option>
        </select>

        <select id="instSelect">
            <option value="sawtooth">üé∏ Guitar</option>
            <option value="triangle">üéπ Piano</option>
            <option value="sine">üîî Bell</option>
            <option value="square">üéÆ 8-bit</option>
        </select>

        <div class="param-group" style="border-left: 1px solid #444; padding-left: 5px;">
            <span>V.Spd: <span id="rateDisplay">0.6</span>x</span>
            <input type="range" id="rateRange" min="0.5" max="2.0" step="0.1" value="0.6" oninput="updateRate()">
        </div>

        <div class="param-group">
            <span>Sync: <span id="offsetDisplay">300</span>ms</span>
            <input type="range" id="offsetRange" min="0" max="1000" step="10" value="300" oninput="updateOffset()">
        </div>

        <button class="ctrl-btn stop-btn" id="ttsBtn" onclick="toggleTTS()">üó£Ô∏è –°–ª–æ–≤–∞</button>
        <button class="ctrl-btn stop-btn active" id="capoBtn" onclick="toggleCapo()">üé∏ Capo: 3</button>
        
        <button class="ctrl-btn save-btn" onclick="saveToJSON()" title="Save changes to JSON box">üíæ SAVE</button>
    </div>

    <div id="score-container">
        <div id="zoom-wrapper"></div>
    </div>

    <div id="teleprompter-container">
        <ul id="lyrics-list"></ul>
    </div>

<script>
    // --- DEFAULT SONG DATA ---
    const defaultSong = {
        title: "G.E.M. - Ê°ÉËä±ËØ∫ (Tao Hua Nuo)",
        subtitle: "A Life of Love and Obsession",
        bpm: 140,
        timeline: [
            { "section": "Intro", "ch": "F", "txt": ["","","",""], "trans": "(–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ)" },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","ch≈´/Âàù/–≤–ø–µ—Ä–≤—ã–µ","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","ru√≤/Ëã•/—Å–ª–æ–≤–Ω–æ"], "trans": "–°–ª–æ–≤–Ω–æ –ø–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞..." },
            { "section": "Verse 1", "ch": "F", "txt": ["qi«én/Áº±/–ø—É—Ç—ã","","qu«én/Áªª/–ª—é–±–æ–≤—å",""], "trans": "–ù–µ—Ä–∞–∑—Ä—ã–≤–Ω–∞—è, –∑–∞–ø—É—Ç–∞–Ω–Ω–∞—è —Å–≤—è–∑—å..." },
            { "ch": "G", "txt": ["sh√¨/Ë™ì/–∫–ª—è—Ç–≤–∞","","y√°n/Ë®Ä/—Å–ª–æ–≤–∞",""] },
            { "ch": "Em", "txt": ["fƒìng/È£é/–≤–µ—Ç–µ—Ä","chuƒ´/Âêπ/–¥—É—Ç—å","y√∫n/‰∫ë/–æ–±–ª–∞–∫–æ","sh≈´/Ëàí/—Å–≤–æ–±–æ–¥–Ω–æ"], "trans": "–í–µ—Ç–µ—Ä —Ä–∞–∑–≥–æ–Ω—è–µ—Ç –æ–±–ª–∞–∫–∞, –∏ –æ–Ω–∏ –ø–ª—ã–≤—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ." },
            { "ch": "Am", "txt": ["ju«én/Âç∑/—Å–≤–µ—Ä–Ω—É—Ç—å","","su√¨/Â≤Å/–≥–æ–¥—ã","yu√®/Êúà/–º–µ—Å—è—Ü—ã"] },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂–¥—É","","","w√®n/ÈóÆ/—Å–ø—Ä–æ—Å–∏"], "trans": "–°—Ä–µ–¥–∏ –±–µ–≥–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–ø—Ä–æ—Å–∏:" },
            { "ch": "G", "txt": ["jƒ´n/‰ªä/—Å–µ–≥–æ–¥–Ω—è","xƒ´/Â§ï/–≤–µ—á–µ—Ä","y√≤u/Âèà/—Å–Ω–æ–≤–∞",""] },
            { "ch": "C", "txt": ["h√©/‰Ωï/–∫–∞–∫–æ–π","ni√°n/Âπ¥/–≥–æ–¥","",""], "trans": "–ö–∞–∫–æ–π –∂–µ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä –∏ –∫–∞–∫–æ–π –≥–æ–¥?" },
            { "ch": "C", "txt": ["","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ","y«íu/Êúâ/–∏–º–µ—Ç—å","xƒ´/ÁäÄ/–µ–¥–∏–Ω–µ–Ω–∏–µ"], "trans": "–°–µ—Ä–¥—Ü–∞ –±—å—é—Ç—Å—è –≤ —É–Ω–∏—Å–æ–Ω." },
            { "ch": "F", "txt": ["d√†n/‰ΩÜ/–ª–∏—à—å","","yu√†n/ÊÑø/–∂–µ–ª–∞—Ç—å",""], "trans": "–õ–∏—à—å —Ö–æ—á—É —É–¥–µ—Ä–∂–∞—Ç—å —ç—Ç—É –º—ã—Å–ª—å." },
            { "ch": "G", "txt": ["zh√≠/Êâß/–¥–µ—Ä–∂–∞—Ç—å","","ni√†n/Âøµ/–º—ã—Å–ª—å",""] },
            { "ch": "Em", "txt": ["l√∫n/ËΩÆ/–∫–æ–ª–µ—Å–æ","hu√≠/Âõû/–≤–æ–∑–≤—Ä–∞—Ç","gu√≤/Ëøá/–ø—Ä–æ—à–ª–æ","jƒ´ng/Áªè/—Å–∫–≤–æ–∑—å"], "trans": "–ö–æ–ª–µ—Å–æ –ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–π –ø—Ä–æ—à–ª–æ —á–µ—Ä–µ–∑ –≥–æ–¥–∞." },
            { "ch": "Am", "txt": ["ni√°n/Âπ¥/–≥–æ–¥","","t√°n/Âºπ/—â–µ–ª—á–æ–∫","zh«ê/Êåá/–ø–∞–ª–µ—Ü"] },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–ø—Ä–æ–º–µ–∂—É—Ç–æ–∫","","f√°n/ÁπÅ/–ø—ã—à–Ω—ã–π","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "–í –º–≥–Ω–æ–≤–µ–Ω–∏–µ –æ–∫–∞ –ø—ã—à–Ω—ã–µ —Ü–≤–µ—Ç—ã..." },
            { "ch": "G", "txt": ["kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç—å","lu√≤/ËêΩ/—É–ø–∞—Å—Ç—å","du≈ç/Â§ö/–º–Ω–æ–≥–æ",""], "trans": "...—Ä–∞—Å–ø—É—Å–∫–∞–ª–∏—Å—å –∏ –æ–ø–∞–¥–∞–ª–∏ –±–µ—Å—á–∏—Å–ª–µ–Ω–Ω–æ." },
            { "ch": "C", "txt": ["sh«éo/Â∞ë/–º–∞–ª–æ","bi√†n/ÈÅç/—Ä–∞–∑","",""] },
            { "ch": "C", "txt": ["","zh√®/Ëøô/—ç—Ç–∞","yƒ´/‰∏Ä/–æ–¥–Ω–∞","sh√¨/‰∏ñ/–∂–∏–∑–Ω—å"], "trans": "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏..." },
            { "section": "Pre-Chorus", "ch": "F", "txt": ["qiƒÅn/Áâµ/—Ç—è–Ω—É—Ç—å","","b√†n/Áªä/–æ–∫–æ–≤—ã",""], "trans": "...–Ω–∞—à–∞ –∑–∞–ø—É—Ç–∞–Ω–Ω–∞—è —Å–≤—è–∑—å..." },
            { "ch": "G", "txt": ["ji≈´/Á∫†/—Å–ø–ª–µ—Å—Ç–∏","","ji√©/Áªì/—É–∑–µ–ª",""] },
            { "ch": "Em", "txt": ["ch√π/Ëß¶/—Ç—Ä–æ–Ω—É—Ç—å","d√≤ng/Âä®/–¥–≤–∏–≥–∞—Ç—å","le/‰∫Ü/–ø—Ä–æ—à.–≤—Ä","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞—Ç—Ä–æ–Ω—É–ª–∞ —Å—Ç—Ä—É–Ω—ã —Å–µ—Ä–¥—Ü–∞." },
            { "ch": "Am", "txt": ["xi√°n/Âº¶/—Å—Ç—Ä—É–Ω–∞","","xi√†/‰∏ã/—Å–ª–µ–¥","yƒ´/‰∏Ä/–æ–¥–∏–Ω"] },
            { "ch": "F", "txt": ["sh√¨/‰∏ñ/–∂–∏–∑–Ω—å","","","b√π/‰∏ç/–Ω–µ"], "trans": "–í —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏, –Ω–µ –∑–Ω–∞—é..." },
            { "ch": "G", "txt": ["zhƒ´/Áü•/–∑–Ω–∞—Ç—å","kƒõ/ÂèØ/–º–æ—á—å","f«íu/Âê¶/–ª–∏",""] },
            { "ch": "C", "txt": ["z√†i/ÂÜç/—Å–Ω–æ–≤–∞","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","",""], "trans": "...—Å–º–æ–∂–µ–º –ª–∏ –º—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞." },
            { "ch": "C7", "txt": ["","li√∫/Áïô/–æ—Å—Ç–∞–≤–∏—Ç—å","yƒ´/‰∏Ä/–æ–¥–∏–Ω","pi√†n/Áâá/–∫—É—Å–æ–∫"], "trans": "–û—Å—Ç–∞–≤–ª—è—é –æ–¥–∏–Ω –ª–µ–ø–µ—Å—Ç–æ–∫..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "...—Ü–≤–µ—Ç–∫–∞ –ø–µ—Ä—Å–∏–∫–∞, –∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ," },
            { "ch": "G", "txt": ["j√¨/Á∫™/–ø–∞–º—è—Ç—å","","ni√†n/Âøµ/–≤—Å–ø–æ–º–Ω–∏—Ç—å",""] },
            { "ch": "Em", "txt": ["li«éo/‰∫Ü/–∑–∞–≤–µ—Ä—à–∏—Ç—å","qu√®/Âç¥/–Ω–æ","f√∫/ÊµÆ/–ø–ª—ã—Ç—å","shƒìng/Áîü/–∂–∏–∑–Ω—å"], "trans": "–ß—Ç–æ–± –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å—É–¥—å–±—É —ç—Ç–æ–π –±—Ä–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏." },
            { "ch": "Am", "txt": ["yu√°n/Áºò/—Å—É–¥—å–±–∞","","m√©i/Áúâ/–±—Ä–æ–≤–∏","m√π/ÁõÆ/–≥–ª–∞–∑–∞"] },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂","","","h√°i/Ëøò/–≤—Å—ë –µ—â–µ"], "trans": "–í —Ç–≤–æ–∏—Ö –≥–ª–∞–∑–∞—Ö –≤—Å—ë –µ—â—ë..." },
            { "ch": "Dm", "txt": ["y«íu/Êúâ/–µ—Å—Ç—å","w«í/Êàë/–º–æ—è","de/ÁöÑ/–∏–∑",""] },
            { "ch": "G", "txt": ["sƒ´/ÊÄù/–¥—É–º–∞—Ç—å","ni√†n/Âøµ/—Å–∫—É—á–∞—Ç—å","",""], "trans": "...–∂–∏–≤–µ—Ç —Ç–æ—Å–∫–∞ –æ–±–æ –º–Ω–µ." },
            { "ch": "G", "txt": ["","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","c√πn/ÂØ∏/—Ü—É–Ω—å"], "trans": "–û–¥–∏–Ω —Ü—É–Ω—å –∑–µ–º–ª–∏..." },
            { "section": "Chorus", "ch": "C", "txt": ["t«î/Âúü/–∑–µ–º–ª—è","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","ni√°n/Âπ¥/–≥–æ–¥"], "trans": "...–æ–¥–∏–Ω –≥–æ–¥ –¥–µ—Ä–µ–≤—å–µ–≤..." },
            { "ch": "G", "txt": ["m√π/Êú®/–¥–µ—Ä–µ–≤–æ","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "...–æ–¥–∏–Ω —Ü–≤–µ—Ç–æ–∫..." },
            { "ch": "Am", "txt": ["yƒ´/‰∏Ä/–æ–¥–∏–Ω","sh√π/Ê†ë/–¥—Ä–µ–≤–æ","yƒ´/‰∏Ä/–æ–¥–∏–Ω","tƒÅn/Ë¥™/–∂–∞–∂–¥–∞"], "trans": "...–æ–¥–Ω–æ –¥–µ—Ä–µ–≤–æ, –æ–¥–Ω–∞ –∂–∞–∂–¥–∞." },
            { "ch": "Em", "txt": ["t√∫/Âõæ/—Å—Ö–µ–º–∞","","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","sh√¨/ÊòØ/–µ—Å—Ç—å"], "trans": "–ß—É–≤—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ –≤–∏–¥ –ª—é–±–≤–∏," },
            { "ch": "F", "txt": ["zh«íng/Áßç/–≤–∏–¥","","","√†i/Áà±/–ª—é–±–æ–≤—å"] },
            { "ch": "C", "txt": ["piƒÅn/ÂÅè/–Ω–∞–∫–ª–æ–Ω","kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç","z√†i/Âú®/–≤",""], "trans": "...—á—Ç–æ —Ä–∞—Å—Ü–≤–µ–ª–∞ –ø–æ –æ—à–∏–±–∫–µ –Ω–∞ –ª–æ–∂–Ω–æ–º –ø—É—Ç–∏." },
            { "ch": "Dm", "txt": ["m√≠/Ëø∑/–±–ª—É–∂–¥–∞—Ç—å","t√∫/ÈÄî/–ø—É—Ç—å","",""] },
            { "ch": "G", "txt": ["","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","qi√°n/Ââç/–ø–µ—Ä–µ–¥"], "trans": "–ó–∞–±—ã—Ç—å –ø—É—Ç—å –≤–ø–µ—Ä–µ–¥..." },
            { "ch": "C", "txt": ["l√π/Ë∑Ø/–¥–æ—Ä–æ–≥–∞","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","ji√π/Êóß/—Å—Ç–∞—Ä—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å –ø—Ä–æ—à–ª–æ–µ..." },
            { "ch": "G", "txt": ["w√π/Áâ©/–≤–µ—â—å","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞–±—ã—Ç—å —á—É–≤—Å—Ç–≤–∞, –∑–∞–±—ã—Ç—å —Ç–µ–±—è..." },
            { "ch": "Am", "txt": ["w√†ng/Âøò/–∑–∞–±—ã—Ç—å","n«ê/‰Ω†/—Ç—ã","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","zu√¨/ÊúÄ/—Å–∞–º—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ." },
            { "ch": "Em", "txt": ["ch≈´/Âàù/–Ω–∞—á–∞–ª–æ","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "–ü—è—Ç–Ω–∞ —Ü–≤–µ—Ç–æ–≤..." },
            { "ch": "F", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "...–æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ –¥–æ—Ä–æ–≥–µ," },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–≥–¥–µ —è –ª—é–±–∏–ª–∞ —Ç–µ–±—è." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "section": "Instrumental", "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","zh√®/Ëøô/—ç—Ç–∞","yƒ´/‰∏Ä/–æ–¥–Ω–∞","sh√¨/‰∏ñ/–∂–∏–∑–Ω—å"], "trans": "–í —ç—Ç–æ–π –∂–∏–∑–Ω–∏..." },
            { "section": "Pre-Chorus", "ch": "F", "txt": ["qiƒÅn/Áâµ/—Ç—è–Ω—É—Ç—å","","b√†n/Áªä/–æ–∫–æ–≤—ã",""], "trans": "...–Ω–∞—à–∞ –∑–∞–ø—É—Ç–∞–Ω–Ω–∞—è —Å–≤—è–∑—å..." },
            { "ch": "G", "txt": ["ji≈´/Á∫†/—Å–ø–ª–µ—Å—Ç–∏","","ji√©/Áªì/—É–∑–µ–ª",""] },
            { "ch": "Em", "txt": ["ch√π/Ëß¶/—Ç—Ä–æ–Ω—É—Ç—å","d√≤ng/Âä®/–¥–≤–∏–≥–∞—Ç—å","le/‰∫Ü/–ø—Ä–æ—à.–≤—Ä","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞—Ç—Ä–æ–Ω—É–ª–∞ —Å—Ç—Ä—É–Ω—ã —Å–µ—Ä–¥—Ü–∞." },
            { "ch": "Am", "txt": ["xi√°n/Âº¶/—Å—Ç—Ä—É–Ω–∞","","xi√†/‰∏ã/—Å–ª–µ–¥","yƒ´/‰∏Ä/–æ–¥–∏–Ω"] },
            { "ch": "F", "txt": ["sh√¨/‰∏ñ/–∂–∏–∑–Ω—å","","","b√π/‰∏ç/–Ω–µ"], "trans": "–í —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏, –Ω–µ –∑–Ω–∞—é..." },
            { "ch": "G", "txt": ["zhƒ´/Áü•/–∑–Ω–∞—Ç—å","kƒõ/ÂèØ/–º–æ—á—å","f«íu/Âê¶/–ª–∏",""] },
            { "ch": "C", "txt": ["z√†i/ÂÜç/—Å–Ω–æ–≤–∞","ji√†n/ËßÅ/–≤–∏–¥–µ—Ç—å","",""], "trans": "...—Å–º–æ–∂–µ–º –ª–∏ –º—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è —Å–Ω–æ–≤–∞." },
            { "ch": "C7", "txt": ["","li√∫/Áïô/–æ—Å—Ç–∞–≤–∏—Ç—å","yƒ´/‰∏Ä/–æ–¥–∏–Ω","pi√†n/Áâá/–∫—É—Å–æ–∫"], "trans": "–û—Å—Ç–∞–≤–ª—è—é –æ–¥–∏–Ω –ª–µ–ø–µ—Å—Ç–æ–∫..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "...—Ü–≤–µ—Ç–∫–∞ –ø–µ—Ä—Å–∏–∫–∞, –∫–∞–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ," },
            { "ch": "G", "txt": ["j√¨/Á∫™/–ø–∞–º—è—Ç—å","","ni√†n/Âøµ/–≤—Å–ø–æ–º–Ω–∏—Ç—å",""] },
            { "ch": "Em", "txt": ["li«éo/‰∫Ü/–∑–∞–≤–µ—Ä—à–∏—Ç—å","qu√®/Âç¥/–Ω–æ","f√∫/ÊµÆ/–ø–ª—ã—Ç—å","shƒìng/Áîü/–∂–∏–∑–Ω—å"], "trans": "–ß—Ç–æ–± –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å—É–¥—å–±—É —ç—Ç–æ–π –±—Ä–µ–Ω–Ω–æ–π –∂–∏–∑–Ω–∏." },
            { "ch": "Am", "txt": ["yu√°n/Áºò/—Å—É–¥—å–±–∞","","m√©i/Áúâ/–±—Ä–æ–≤–∏","m√π/ÁõÆ/–≥–ª–∞–∑–∞"] },
            { "ch": "F", "txt": ["jiƒÅn/Èó¥/–º–µ–∂","","","h√°i/Ëøò/–≤—Å—ë –µ—â–µ"], "trans": "–í —Ç–≤–æ–∏—Ö –≥–ª–∞–∑–∞—Ö –≤—Å—ë –µ—â—ë..." },
            { "ch": "Dm", "txt": ["y«íu/Êúâ/–µ—Å—Ç—å","w«í/Êàë/–º–æ—è","de/ÁöÑ/–∏–∑",""] },
            { "ch": "G", "txt": ["sƒ´/ÊÄù/–¥—É–º–∞—Ç—å","ni√†n/Âøµ/—Å–∫—É—á–∞—Ç—å","",""], "trans": "...–∂–∏–≤–µ—Ç —Ç–æ—Å–∫–∞ –æ–±–æ –º–Ω–µ." },
            { "ch": "G", "txt": ["","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","c√πn/ÂØ∏/—Ü—É–Ω—å"], "trans": "–û–¥–∏–Ω —Ü—É–Ω—å –∑–µ–º–ª–∏..." },
            { "section": "Chorus", "ch": "C", "txt": ["t«î/Âúü/–∑–µ–º–ª—è","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","ni√°n/Âπ¥/–≥–æ–¥"], "trans": "...–æ–¥–∏–Ω –≥–æ–¥ –¥–µ—Ä–µ–≤—å–µ–≤..." },
            { "ch": "G", "txt": ["m√π/Êú®/–¥–µ—Ä–µ–≤–æ","","yƒ´/‰∏Ä/–æ–¥–∏–Ω","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫"], "trans": "...–æ–¥–∏–Ω —Ü–≤–µ—Ç–æ–∫..." },
            { "ch": "Am", "txt": ["yƒ´/‰∏Ä/–æ–¥–∏–Ω","sh√π/Ê†ë/–¥—Ä–µ–≤–æ","yƒ´/‰∏Ä/–æ–¥–∏–Ω","tƒÅn/Ë¥™/–∂–∞–∂–¥–∞"], "trans": "...–æ–¥–Ω–æ –¥–µ—Ä–µ–≤–æ, –æ–¥–Ω–∞ –∂–∞–∂–¥–∞." },
            { "ch": "Em", "txt": ["t√∫/Âõæ/—Å—Ö–µ–º–∞","","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","sh√¨/ÊòØ/–µ—Å—Ç—å"], "trans": "–ß—É–≤—Å—Ç–≤–∞ ‚Äî —ç—Ç–æ –≤–∏–¥ –ª—é–±–≤–∏," },
            { "ch": "F", "txt": ["zh«íng/Áßç/–≤–∏–¥","","","√†i/Áà±/–ª—é–±–æ–≤—å"] },
            { "ch": "C", "txt": ["piƒÅn/ÂÅè/–Ω–∞–∫–ª–æ–Ω","kƒÅi/ÂºÄ/–æ—Ç–∫—Ä—ã—Ç","z√†i/Âú®/–≤",""], "trans": "...—á—Ç–æ —Ä–∞—Å—Ü–≤–µ–ª–∞ –ø–æ –æ—à–∏–±–∫–µ –Ω–∞ –ª–æ–∂–Ω–æ–º –ø—É—Ç–∏." },
            { "ch": "Dm", "txt": ["m√≠/Ëø∑/–±–ª—É–∂–¥–∞—Ç—å","t√∫/ÈÄî/–ø—É—Ç—å","",""] },
            { "ch": "G", "txt": ["","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","qi√°n/Ââç/–ø–µ—Ä–µ–¥"], "trans": "–ó–∞–±—ã—Ç—å –ø—É—Ç—å –≤–ø–µ—Ä–µ–¥..." },
            { "ch": "C", "txt": ["l√π/Ë∑Ø/–¥–æ—Ä–æ–≥–∞","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","ji√π/Êóß/—Å—Ç–∞—Ä—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å –ø—Ä–æ—à–ª–æ–µ..." },
            { "ch": "G", "txt": ["w√π/Áâ©/–≤–µ—â—å","","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","xƒ´n/ÂøÉ/—Å–µ—Ä–¥—Ü–µ"], "trans": "...–∑–∞–±—ã—Ç—å —á—É–≤—Å—Ç–≤–∞, –∑–∞–±—ã—Ç—å —Ç–µ–±—è..." },
            { "ch": "Am", "txt": ["w√†ng/Âøò/–∑–∞–±—ã—Ç—å","n«ê/‰Ω†/—Ç—ã","w√†ng/Âøò/–∑–∞–±—ã—Ç—å","zu√¨/ÊúÄ/—Å–∞–º—ã–π"], "trans": "...–∑–∞–±—ã—Ç—å —Å–∞–º–æ–µ –Ω–∞—á–∞–ª–æ." },
            { "ch": "Em", "txt": ["ch≈´/Âàù/–Ω–∞—á–∞–ª–æ","","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫",""], "trans": "–ü—è—Ç–Ω–∞ —Ü–≤–µ—Ç–æ–≤..." },
            { "ch": "F", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "...–æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ –¥–æ—Ä–æ–≥–µ," },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–≥–¥–µ —è –ª—é–±–∏–ª–∞ —Ç–µ–±—è." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""] },
            { "ch": "C", "txt": ["","qi√°n/Ëôî/–∏—Å–∫—Ä–µ–Ω–Ω–µ","ch√©ng/ËØö/—á–µ—Å—Ç–Ω–æ","s√π/Â§ô/–¥–∞–≤–Ω–∏–π"], "trans": "–ò—Å–∫—Ä–µ–Ω–Ω–µ –º–æ–ª—é –æ —Å–ª–µ–¥—É—é—â–µ–π –∂–∏–∑–Ω–∏..." },
            { "section": "Bridge", "ch": "Am", "txt": ["yu√†n/ÊÑø/–∂–µ–ª–∞—Ç—å","","l√°i/Êù•/–ø—Ä–∏–π—Ç–∏","sh√¨/‰∏ñ/–º–∏—Ä"] },
            { "ch": "Em", "txt": ["l√π/Ë∑Ø/–ø—É—Ç—å","","yƒ´/‰∏Ä/–æ–¥–Ω–∞","ni√†n/Âøµ/–º—ã—Å–ª—å"], "trans": "–û–¥–Ω–∞ –º—ã—Å–ª—å –æ —Ü–≤–µ—Ç–∞—Ö –ø–µ—Ä—Å–∏–∫–∞..." },
            { "ch": "F", "txt": ["t√°o/Ê°É/–ø–µ—Ä—Å–∏–∫","huƒÅ/Ëä±/—Ü–≤–µ—Ç–æ–∫","yƒ´n/Âõ†/–ø—Ä–∏—á–∏–Ω–∞","gu«í/Êûú/—Å–ª–µ–¥—Å—Ç–≤–∏–µ"], "trans": "...–ø–µ—Ä–µ–ø—Ä–∞–≤–∏—Ç –Ω–∞—Å —á–µ—Ä–µ–∑ –∫–∞—Ä–º—É." },
            { "ch": "G", "txt": ["d√π/Ê∏°/–ø–µ—Ä–µ–ø—Ä–∞–≤–∞","","n√†/ÈÇ£/—Ç–æ—Ç","yƒ´/‰∏Ä/–æ–¥–∏–Ω"] },
            { "ch": "C", "txt": ["ni√†n/Âøµ/–º—ã—Å–ª—å","","j«ê/Âá†/—Å–∫–æ–ª—å–∫–æ","quƒì/Èòô/–ø–µ—Å–µ–Ω"], "trans": "–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Ä–µ–º—è –ø–æ–≤—Ç–æ—Ä—è–ª–æ—Å—å?" },
            { "ch": "G", "txt": ["sh√≠/Êó∂/–≤—Ä–µ–º—è","guƒÅng/ÂÖâ/—Å–≤–µ—Ç","z√†i/Âú®/–≤",""] },
            { "ch": "C", "txt": ["ch√≥ng/Èáç/—Å–Ω–æ–≤–∞","f√π/Â§ç/–ø–æ–≤—Ç–æ—Ä","",""] },
            { "ch": "E", "txt": ["","","tƒ´ng/Âê¨/—Å–ª—É—à–∞—Ç—å","y«î/Èõ®/–¥–æ–∂–¥—å"], "trans": "–°–ª—É—à–∞—è –¥–æ–∂–¥—å..." },
            { "section": "Ending", "ch": "Am", "txt": ["sh≈´/‰π¶/–ø–∏—Å–∞—Ç—å","","w√†ng/Êúõ/—Å–º–æ—Ç—Ä–µ—Ç—å","tiƒÅn/Â§©/–Ω–µ–±–æ"], "trans": "...–≥–ª—è–¥—è –Ω–∞ –Ω–µ–±–æ –∏ –æ–∑–µ—Ä–æ." },
            { "ch": "Em", "txt": ["h√∫/Êπñ/–æ–∑–µ—Ä–æ","","r√©n/‰∫∫/—á–µ–ª–æ–≤–µ–∫","jiƒÅn/Èó¥/–º–µ–∂"] },
            { "ch": "F", "txt": ["li√°o/ÂØ•/–ø—É—Å—Ç–æ","li√°o/ÂØ•/—Ç–∏—Ö–æ","q√≠ng/ÊÉÖ/—á—É–≤—Å—Ç–≤–æ","n√°n/Èöæ/—Ç—Ä—É–¥–Ω–æ"], "trans": "–í –º–∏—Ä–µ –ª—é–¥–µ–π –æ–¥–∏–Ω–æ–∫–æ, —á—É–≤—Å—Ç–≤–∞ —Ç—Ä—É–¥–Ω–æ –≤—ã—Ä–∞–∑–∏—Ç—å." },
            { "ch": "G", "txt": ["s√π/ËØâ/—Å–∫–∞–∑–∞—Ç—å","","hu√≠/Âõû/–≤–æ–∑–≤—Ä–∞—Ç","y√¨/ÂøÜ/–ø–∞–º—è—Ç—å"] },
            { "ch": "C", "txt": ["bƒÅn/Êñë/–ø—è—Ç–Ω–æ","bƒÅn/Êñë/–ø—è—Ç–Ω–æ","","li√∫/Áïô/–æ—Å—Ç–∞—Ç—å—Å—è"], "trans": "–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—è—Ç–Ω–∞–º–∏ –æ—Å—Ç–∞–ª–∏—Å—å..." },
            { "ch": "G", "txt": ["z√†i/Âú®/–Ω–∞","√†i/Áà±/–ª—é–±–∏—Ç—å","n«ê/‰Ω†/—Ç–µ–±—è",""], "trans": "...–Ω–∞ –¥–æ—Ä–æ–≥–µ –ª—é–±–≤–∏ –∫ —Ç–µ–±–µ." },
            { "ch": "C", "txt": ["de/ÁöÑ/–∏–∑","l√π/Ë∑Ø/–ø—É—Ç—å","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "section": "Outro", "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "Em", "txt": ["","","",""] },
            { "ch": "Am", "txt": ["","","",""] },
            { "ch": "F", "txt": ["","","",""] },
            { "ch": "G", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] },
            { "ch": "C", "txt": ["","","",""] }
        ]
    };
    // --- GLOBAL STATE ---
    let currentSong = JSON.parse(JSON.stringify(defaultSong));
    let audioCtx = null;
    let masterGain = null;
    
    // TIMING VARIABLES (WEB AUDIO CLOCK)
    let isPlaying = false;
    let lookahead = 25.0; // How frequently to call scheduling function (in milliseconds)
    let scheduleAheadTime = 0.1; // How far ahead to schedule audio (in seconds)
    let nextNoteTime = 0.0; // when the next note is due.
    let timerID; // setInterval ID
    let notesInQueue = []; // For UI synchronization

    // State
    let currentBar = 0;
    let currentBeat = 0;
    
    // Preferences
    let bpm = 150; 
    let ttsRate = 0.6; 
    let ttsOffset = 300; 
    let isCapo = true;
    let isTTS = true;
    
    let selectedVoice = null;
    let availableVoices = [];
    let phraseCache = {}; 
    let lyricLines = []; 

    const noteMap = {'C':261.63,'C#':277.18,'Db':277.18,'D':293.66,'D#':311.13,'Eb':311.13,'E':329.63,'F':349.23,'F#':369.99,'Gb':369.99,'G':392.00,'G#':415.30,'Ab':415.30,'A':440.00,'A#':466.16,'Bb':466.16,'B':493.88};
    const semitones = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

    // --- INIT ---
    function init() {
        document.getElementById('json-input').value = JSON.stringify(currentSong, null, 4);
        applySongData();
        window.speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices(); 
        
        // Start the UI drawing loop
        requestAnimationFrame(draw);
    }

    // --- JSON EDITOR ---
    function toggleJsonPanel() {
        const p = document.getElementById('json-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    function loadFromInput() {
        try {
            const raw = document.getElementById('json-input').value;
            const parsed = JSON.parse(raw);
            if(!parsed.timeline) throw new Error("Missing 'timeline'");
            stop();
            currentSong = parsed;
            applySongData();
            document.getElementById('json-panel').style.display = 'none';
        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    function applySongData() {
        document.getElementById('song-title').innerText = currentSong.title || "Untitled";
        document.getElementById('song-subtitle').innerText = currentSong.subtitle || "";
        bpm = currentSong.bpm || 120;
        document.getElementById('bpmRange').value = bpm;
        document.getElementById('bpmDisplay').innerText = bpm;
        resetPlayhead();
        generatePhrases();
        buildTeleprompterList(); 
        renderScore();
    }

    function saveToJSON() {
        currentSong.bpm = bpm;
        document.getElementById('json-input').value = JSON.stringify(currentSong, null, 4);
        document.getElementById('json-panel').style.display = 'block';
    }

    function copyToClipboard() {
        document.getElementById('json-input').select();
        document.execCommand('copy');
    }

    // --- VOICE ---
    function loadVoices() {
        availableVoices = window.speechSynthesis.getVoices();
        const select = document.getElementById('voiceSelect');
        select.innerHTML = "";
        
        availableVoices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.innerText = v.name.substring(0, 20) + (v.name.length>20?'...':'');
            select.appendChild(opt);
        });

        let target = availableVoices.find(v => v.name === "Google ÂúãË™ûÔºàËá∫ÁÅ£Ôºâ") || 
                     availableVoices.find(v => v.lang.includes('zh'));
        
        if (target) {
            select.value = target.name;
            selectedVoice = target;
        } else if (availableVoices.length) {
            selectedVoice = availableVoices[0];
            select.value = availableVoices[0].name;
        }
    }
    
    function updateVoice() {
        selectedVoice = availableVoices.find(v => v.name === document.getElementById('voiceSelect').value);
    }

    // --- LOGIC ---
    function generatePhrases() {
        phraseCache = {}; 
        let currentPhrase = "";
        let startKey = null;

        currentSong.timeline.forEach((m, mIdx) => {
            m.txt.forEach((txt, bIdx) => {
                let parts = txt.split('/');
                let hz = parts.length > 1 ? parts[1] : txt;
                let key = `${mIdx}-${bIdx}`;
                
                if (hz) {
                    if (!currentPhrase) startKey = key;
                    currentPhrase += hz;
                } else {
                    if (currentPhrase && startKey) {
                        phraseCache[startKey] = currentPhrase;
                        currentPhrase = "";
                        startKey = null;
                    }
                }
            });
        });
        if (currentPhrase && startKey) phraseCache[startKey] = currentPhrase;
    }

    function buildTeleprompterList() {
        const list = document.getElementById('lyrics-list');
        list.innerHTML = "";
        lyricLines = [];
        
        currentSong.timeline.forEach((m, idx) => {
            if (m.trans) {
                lyricLines.push({ measureIdx: idx, text: m.trans, id: `lyric-${idx}` });
            }
        });

        lyricLines.forEach(line => {
            let li = document.createElement('li');
            li.className = 'lyric-line';
            li.id = line.id;
            li.innerText = line.text;
            li.onclick = () => seekTo(line.measureIdx, 0);
            list.appendChild(li);
        });
    }

    function renderScore() {
        const wrapper = document.getElementById('zoom-wrapper');
        wrapper.innerHTML = '';
        
        currentSong.timeline.forEach((m, mIdx) => {
            const mDiv = document.createElement('div');
            mDiv.className = 'measure';
            mDiv.id = `m-${mIdx}`;
            
            const info = document.createElement('div');
            info.className = 'measure-info';
            info.innerHTML = `<span>${mIdx+1}</span>` + (m.section ? `<span class="sect-label">${m.section}</span>` : ``);
            mDiv.appendChild(info);

            const row = document.createElement('div');
            row.className = 'beats-row';

            for (let b=0; b<4; b++) {
                const bDiv = document.createElement('div');
                bDiv.className = 'beat';
                bDiv.id = `b-${mIdx}-${b}`;
                if(phraseCache[`${mIdx}-${b}`]) bDiv.classList.add('phrase-start');

                bDiv.onclick = (e) => {
                    if(e.target.tagName !== 'INPUT') seekTo(mIdx, b);
                };

                // Chord
                if (b === 0) {
                    const cIn = document.createElement('input');
                    cIn.className = 'chord-edit';
                    cIn.value = m.ch || '';
                    cIn.onchange = (e) => { m.ch = e.target.value; };
                    bDiv.appendChild(cIn);
                } else {
                    bDiv.innerHTML += '<div style="height:18px"></div>';
                }

                // Lyric
                const lIn = document.createElement('input');
                lIn.className = 'lyric-edit';
                let rawText = m.txt[b] || "";
                let parts = rawText.split('/');
                let py = parts.length > 1 ? parts[0] : "";
                let hz = parts.length > 1 ? parts[1] : rawText;
                let tr = parts.length > 2 ? parts[2] : "";
                lIn.value = hz;

                lIn.onfocus = (e) => {
                    bDiv.classList.add('editing');
                    e.target.value = m.txt[b] || "";
                };
                lIn.onblur = (e) => {
                    bDiv.classList.remove('editing');
                    m.txt[b] = e.target.value;
                    generatePhrases();
                    renderScore(); 
                };
                lIn.onkeydown = (e) => { if(e.key === 'Enter') lIn.blur(); };

                const pDiv = document.createElement('div');
                pDiv.className = 'pinyin-sub';
                pDiv.innerText = py;
                
                const tDiv = document.createElement('div');
                tDiv.className = 'trans-sub';
                tDiv.innerText = tr;

                bDiv.appendChild(pDiv);
                bDiv.appendChild(lIn);
                bDiv.appendChild(tDiv);
                row.appendChild(bDiv);
            }
            mDiv.appendChild(row);
            wrapper.appendChild(mDiv);
        });
    }

    // --- ACCURATE AUDIO ENGINE ---

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            updateVol();
            masterGain.connect(audioCtx.destination);
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function togglePlay() { 
        initAudio(); 
        if(isPlaying) stop(); else play(); 
    }

    function play() {
        if (isPlaying) return;
        isPlaying = true;
        
        // IMPORTANT: Set Start Time
        nextNoteTime = audioCtx.currentTime + 0.1;
        
        document.getElementById('playBtn').innerText = "‚è∏ PAUSE";
        document.getElementById('playBtn').classList.add('playing');
        
        // Start Scheduler Loop
        timerID = setInterval(scheduler, lookahead);
    }

    function stop() {
        isPlaying = false;
        clearInterval(timerID);
        window.speechSynthesis.cancel();
        document.getElementById('playBtn').innerText = "‚ñ∂ PLAY";
        document.getElementById('playBtn').classList.remove('playing');
        
        // Clear UI
        document.querySelectorAll('.beat.active').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.lyric-line.active').forEach(e => e.classList.remove('active'));
        notesInQueue = [];
    }

    function resetPlayhead() {
        currentBar = 0;
        currentBeat = 0;
        notesInQueue = [];
    }

    function scheduler() {
        // While there are notes that will need to play before the next interval, schedule them
        while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
            scheduleNote(currentBar, currentBeat, nextNoteTime);
            nextNote();
        }
    }

    function scheduleNote(bar, beat, time) {
        // 1. Push to UI queue for requestAnimationFrame
        notesInQueue.push({ noteTime: time, bar: bar, beat: beat });

        if (bar >= currentSong.timeline.length) return;

        // 2. Play Audio (Oscillator)
        let m = currentSong.timeline[bar];
        if (m && m.ch) {
            playSound(m.ch, beat, time);
        }

        // 3. Schedule TTS (Calculated offset from the strict audio time)
        if (isTTS) {
             let key = `${bar}-${beat}`;
             if(phraseCache[key]) {
                 // Calculate delay until the note time
                 let now = audioCtx.currentTime;
                 let delaySeconds = time - now; 
                 // Convert to ms and subtract the user offset (lookahead for TTS)
                 let timeoutMs = (delaySeconds * 1000) - ttsOffset;
                 
                 if (timeoutMs < 0) timeoutMs = 0;
                 
                 setTimeout(() => {
                     if (isPlaying) speakPhrase(phraseCache[key]);
                 }, timeoutMs);
             }
        }
    }

    function nextNote() {
        const secondsPerBeat = 60.0 / bpm;
        nextNoteTime += secondsPerBeat; // Add beat length to last beat time

        currentBeat++;
        if (currentBeat === 4) {
            currentBeat = 0;
            currentBar++;
            if (currentBar >= currentSong.timeline.length) {
                // We don't stop here instantly, let the scheduler run out
                // But generally, we can loop or stop logic elsewhere.
                // For this editor, let's wrap around or stop? 
                // Let's Loop for now or just let it run out. 
                // To stop correctly:
                setTimeout(() => stop(), 2000); 
                isPlaying = false; // Prevent further scheduling
                clearInterval(timerID);
            }
        }
    }

    // --- VISUAL SYNC (Decoupled from Logic) ---
    function draw() {
        let currentTime = audioCtx ? audioCtx.currentTime : 0;

        while (notesInQueue.length && notesInQueue[0].noteTime < currentTime) {
            let currentNote = notesInQueue[0];
            notesInQueue.splice(0,1); // Remove from queue
            
            // Draw UI
            updateHighlight(currentNote.bar, currentNote.beat);
            syncTeleprompter(currentNote.bar);
        }

        requestAnimationFrame(draw);
    }

    // --- SOUND GEN ---
    function getFreqs(chord, isWeak) {
        if (!chord) return [];
        let root = chord.match(/^[A-G][#b]?/)[0];
        let type = chord.slice(root.length);
        let idx = semitones.findIndex(n => n === root);
        if(idx === -1) return [];
        let shift = isCapo ? 3 : 0;
        let realIdx = (idx + shift) % 12;
        let base = noteMap[semitones[realIdx]];
        let f1 = base / 2;
        let f2 = type.includes('m') ? f1*Math.pow(2, 3/12) : f1*Math.pow(2, 4/12);
        let f3 = f1*Math.pow(2, 7/12);
        let f4 = f1*2;
        return isWeak ? [f2, f3, f4] : [f1, f2, f3, f4];
    }

    function playSound(chord, beat, time) {
        if (!audioCtx || !masterGain || !chord) return;
        let isWeak = beat > 0;
        let freqs = getFreqs(chord, isWeak);
        let dur = isWeak ? 0.08 : 0.12; 
        let type = document.getElementById('instSelect').value || 'sawtooth';

        freqs.forEach((f, i) => {
            let o = audioCtx.createOscillator();
            let g = audioCtx.createGain();
            o.type = type; 
            o.frequency.value = f;
            
            let start = time + i*(isWeak?0.004:0.008); // Use exact scheduled time
            g.gain.setValueAtTime(0, start);
            g.gain.linearRampToValueAtTime(isWeak?0.2:0.3, start+0.01);
            g.gain.exponentialRampToValueAtTime(0.001, start+dur+0.1);
            
            o.connect(g); g.connect(masterGain);
            o.start(start); o.stop(start+dur+0.2);
        });
    }

    function seekTo(m, b) {
        let wasPlaying = isPlaying;
        if(wasPlaying) stop();
        
        currentBar = m;
        currentBeat = b;
        updateHighlight(m, b);
        syncTeleprompter(m);

        if(wasPlaying) play();
        else {
            let txt = currentSong.timeline[m].txt[b];
            let parts = txt.split('/');
            let hz = parts.length > 1 ? parts[1] : txt;
            if(hz) speakPhrase(hz);
        }
    }

    function speakPhrase(text) {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-CN';
        u.rate = ttsRate;
        if(selectedVoice) u.voice = selectedVoice;
        window.speechSynthesis.speak(u);
    }

    function updateHighlight(m, b) {
        document.querySelectorAll('.beat.active').forEach(e => e.classList.remove('active'));
        const el = document.getElementById(`b-${m}-${b}`);
        if(el) {
            el.classList.add('active');
            el.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
        }
    }

    function syncTeleprompter(barIdx) {
        let activeLine = null;
        for (let i = lyricLines.length - 1; i >= 0; i--) {
            if (lyricLines[i].measureIdx <= barIdx) {
                activeLine = lyricLines[i];
                break;
            }
        }
        if (activeLine) {
            document.querySelectorAll('.lyric-line.active').forEach(e => {
                if(e.id !== activeLine.id) e.classList.remove('active');
            });
            let el = document.getElementById(activeLine.id);
            if (el && !el.classList.contains('active')) {
                el.classList.add('active');
                el.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
    }

    function updateVol() { 
        let v = document.getElementById('volRange').value;
        document.getElementById('volDisplay').innerText = v;
        if(masterGain) masterGain.gain.value = v/100; 
    }
    function updateSpeed() { 
        bpm = parseInt(document.getElementById('bpmRange').value); 
        document.getElementById('bpmDisplay').innerText = bpm; 
        // Note: Changing BPM while playing in this simple scheduler 
        // will affect the NEXT beat duration, but won't cause drift.
    }
    function updateRate() {
        ttsRate = parseFloat(document.getElementById('rateRange').value);
        document.getElementById('rateDisplay').innerText = ttsRate.toFixed(1);
    }
    function updateOffset() {
        ttsOffset = parseInt(document.getElementById('offsetRange').value);
        document.getElementById('offsetDisplay').innerText = ttsOffset;
    }
    function toggleTTS() { 
        isTTS = !isTTS; 
        document.getElementById('ttsBtn').innerText = isTTS?"üó£Ô∏è –°–ª–æ–≤–∞: –í–ö–õ":"üó£Ô∏è –°–ª–æ–≤–∞: –í–´–ö–õ"; 
    }
    function toggleCapo() { 
        isCapo = !isCapo; 
        document.getElementById('capoBtn').classList.toggle('active', isCapo); 
    }

    init();

</script>
</body>
</html>
